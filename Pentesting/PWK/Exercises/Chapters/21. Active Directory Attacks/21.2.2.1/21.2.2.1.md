21.2.2.1

# 21.2.2.1.1. Modify the PowerShell script to only return members of the Domain Admins group.

Logon as offsec user via rdesktop on Kali
![cdc6df21d7799fc936dfd73c6a08c266.png](4815ab3f28304308b54070e90ae056d2.png)

On the Windows login screen, sign in as:
domain user `corp\offsec`, password `lab`

```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat getDomainAdminsMembers.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="samAccountName=Domain Admins"
$Result = $Searcher.FindAll()
$Result.Properties.member
```
![6601c40511c52f4abcad27d3eb30f129.png](bb6d1fba0e4b45aca451a5595b8001a7.png)


# 21.2.2.1.2. Modify the PowerShell script to return all computers in the domain.

```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat getDomainComputers.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="objectCategory=computer"
$Result = $Searcher.FindAll()
$Result
```
![d69e99e3fa355bb63a642120eaea9bbf.png](e506d94622c748d497c97090bc7f1280.png)



# 21.2.2.1.3. Add a filter to only return computers running Windows 10.

```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat getDomainComputersWindows10.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="objectCategory=computer"
$Result = $Searcher.FindAll()
# $Result.Properties.operatingsystem
Foreach($obj in $Result)
{
  If ($obj.Properties.operatingsystem -match 'Windows 10') {
      Foreach($prop in $obj.Properties) {
        $prop
      }
  }
}
```

![15496d1aa51aad7feae954f560a0820b.png](a28d970e2b4f468685f35f3adb6bf846.png)
![69f3cb92dde4482c7b943eb82a7b5a66.png](bb0a75d1c6cc485fa4c933c758fb3b09.png)