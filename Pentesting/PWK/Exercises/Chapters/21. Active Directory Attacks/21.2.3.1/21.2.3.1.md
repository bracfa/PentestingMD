21.2.3.1

# 21.2.3.1.1. Repeat the enumeration to uncover the relationship between Secret_Group, Nested_Group, and Another_Nested_Group.

### Get All Domain Groups
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat getDomainGroups.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="objectClass=Group"
$Result = $Searcher.FindAll()
Foreach($obj in $Result)
{
  $obj.Properties.name
}
```
![d8cbbb4d377d86982dc82b4abdfdbcc2.png](57cb7a1865d84547beb4670e7f4315ee.png)
![91327eca9643956bb7f851187713dc3e.png](55506367df444f279ef1a7366020da7f.png)
![2d7c3bf4c02a9a2aca902e713cc878db.png](8b437fc57d984b3e86c85db6e06e1d2f.png)

The interesting groups are: `Secret_Group`, `Nested_Group`, `Another_Nested_Group`

### Enumerate the members in Secret_Group
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat getSecretGroupMembers.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="name=Secret_Group"
$Result = $Searcher.FindAll()
Foreach($obj in $Result)
{
  $obj.Properties.member
}
```
We see that the only member of Secret_Group is Nested_Group
![b20a0c00cadd7607b9664850a6080362.png](9cf6412083e243cb87e7c54709aed566.png)

### Enumerate the members in Nested_Group
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat getNestedGroupMembers.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="name=Nested_Group"
$Result = $Searcher.FindAll()
Foreach($obj in $Result)
{
  $obj.Properties.member
}
```
We see the only member of Nested_Group is Another_Nested_Group
![6ddec0cc5d0dc8446436b06e501a29fe.png](5882a6595ab147d699c95e81728dbc92.png)


### Enumerate the members in Another_Nested_Group
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat getAnotherNestedGroupMembers.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="name=Another_Nested_Group"
$Result = $Searcher.FindAll()
Foreach($obj in $Result)
{
  $obj.Properties.member
}
```
We see that Adam is the only member of Another_Nested_Group
![5fd073085340ec9c147bfc1be58e49e8.png](f9fdd2ad2b624ad7a3311afa374e07f4.png)



# 21.2.3.1.2. The script presented in this section required us to change the group name at each iteration. Adapt the script in order to unravel nested groups programmatically without knowing their names beforehand.

Here is a modified script to show the nested groups and users in Secret_Group. Change the filter to your target group name as needed.
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat unravelNestedGroups.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="(memberOf:1.2.840.113556.1.4.1941:=CN=Secret_Group,OU=CorpGroups,DC=corp,DC=com)"
$Result = $Searcher.FindAll()
Foreach($obj in $Result)
{
  Foreach($prop in $obj.Properties)
  {
    $prop.distinguishedname
  }
}
```
![7ab185288cc41520be662eb5b93cb9e8.png](693e3048eb33409daee51d6c3d1109e8.png)

